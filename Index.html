<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Financial Wellness Trajectory</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --border:#e9ecef;
      --muted:#6b7280;
      --text:#111827;
      --accent:#16a34a;
      --bg:#ffffff;
      --err:#b00020;
      --r:14px;
    }

    body{
      margin:0;
      padding:28px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    /* -------- Dashboard Layout -------- */
    .dashboard{
      display:grid;
      grid-template-columns: 1fr 460px;
      gap:36px;
      align-items:start;
    }

    /* -------- Left Header -------- */
    .mainTitle{
      font-size:42px;
      font-weight:900;
      letter-spacing:.02em;
      text-transform:uppercase;
      display:inline-block;
      border-bottom:6px solid #111;
      padding-bottom:10px;
      line-height:1.05;
    }

    .bigValue{
      font-size:56px;
      font-weight:900;
      margin-top:18px;
      line-height:1;
    }

    .deltaRow{
      margin-top:8px;
      font-size:18px;
      display:flex;
      gap:8px;
      align-items:center;
    }

    .deltaUp{ color:var(--accent); font-weight:900; }
    .deltaDown{ color:#b00020; font-weight:900; }

    /* -------- Chart + Tabs -------- */
    .chartWrap{
      margin-top:28px;
      padding-bottom:18px;
      border-bottom:1px solid var(--border);
    }

    canvas{ max-width:100%; }

    .rangeTabs{
      display:flex;
      gap:26px;
      margin-top:18px;
      padding-bottom:14px;
      border-bottom:1px solid var(--border);
      align-items:center;
      flex-wrap:wrap;
    }

    .rangeTabs button{
      background:none;
      border:none;
      padding:10px 2px;
      font-weight:900;
      cursor:pointer;
      border-bottom:4px solid transparent;
      letter-spacing:.02em;
      border-radius:0;
      width:auto;
      color:#111;
    }
    .rangeTabs button.active{
      color:var(--accent);
      border-bottom-color:var(--accent);
    }

    /* -------- Preview -------- */
    .hint{ font-size:12px; color:var(--muted); margin-top:8px; }
    .scrollBox{
      max-height:260px;
      overflow:auto;
      background:#f9fafb;
      padding:12px;
      border-radius:10px;
      margin-top:16px;
      border:1px solid var(--border);
    }
    pre{ margin:0; font-size:12px; white-space:pre; }

    /* -------- Forecast Summary (NEW) -------- */
    .forecastWrap{
      margin-top:16px;
      border:1px solid var(--border);
      border-radius:12px;
      overflow:hidden;
      background:#fff;
    }
    .forecastHead{
      padding:12px 14px;
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      border-bottom:1px solid var(--border);
      background:#fafafa;
      gap:10px;
      flex-wrap:wrap;
    }
    .forecastTitle{
      font-weight:900;
      letter-spacing:.02em;
      text-transform:uppercase;
      font-size:13px;
    }
    .forecastMeta{
      font-size:12px;
      color:var(--muted);
      font-weight:700;
    }
    .forecastGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      padding:12px 14px 14px;
    }
    .forecastBox{
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      background:#fff;
    }
    .forecastBox h4{
      margin:0 0 10px;
      font-size:13px;
      font-weight:900;
      letter-spacing:.02em;
      text-transform:uppercase;
    }
    .forecastList{
      margin:0;
      padding:0;
      list-style:none;
      display:grid;
      gap:8px;
    }
    .forecastItem{
      display:flex;
      justify-content:space-between;
      gap:12px;
      font-size:13px;
      line-height:1.25;
    }
    .forecastItem .lbl{
      color:#111;
      font-weight:700;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width:260px;
    }
    .forecastItem .amt{
      font-variant-numeric: tabular-nums;
      font-weight:900;
      white-space:nowrap;
    }
    .amt.in{ color:var(--accent); }
    .amt.out{ color:#b00020; }

    .forecastTotals{
      grid-column:1 / -1;
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      background:#fff;
      display:grid;
      gap:10px;
    }
    .totRow{
      display:flex;
      justify-content:space-between;
      gap:12px;
      font-size:13px;
      font-weight:800;
      color:#111;
    }
    .totRow small{
      font-size:12px;
      font-weight:700;
      color:var(--muted);
    }
    .totRow .val{
      font-variant-numeric: tabular-nums;
      font-weight:900;
      white-space:nowrap;
    }
    .netGood{ color:var(--accent); }
    .netBad{ color:#b00020; }

    .forecastNote{
      grid-column:1 / -1;
      font-size:12px;
      color:var(--muted);
      margin-top:-2px;
    }

    /* -------- Sidebar -------- */
    .sidebar{
      border:1px solid var(--border);
      border-radius:10px;
      overflow:hidden;
      background:#fff;
    }

    .sidebarTop{
      display:flex;
      justify-content:space-between;
      padding:18px;
      border-bottom:1px solid var(--border);
      font-weight:900;
      text-transform:uppercase;
      letter-spacing:.02em;
      font-size:18px;
    }

    .accItem{ border-top:1px solid var(--border); }
    .accBtn{
      width:100%;
      background:none;
      border:none;
      padding:18px;
      font-size:22px;
      font-weight:900;
      text-align:left;
      cursor:pointer;
      display:flex;
      justify-content:space-between;
      align-items:center;
      letter-spacing:.01em;
    }
    .accBtn span{ font-size:18px; font-weight:900; }

    .accPanel{ display:none; padding:0 18px 18px; }
    .accItem.open .accPanel{ display:block; }

    /* -------- Forms -------- */
    label{ font-size:12px; color:#444; margin:10px 0 6px; display:block; }
    input, textarea, select, button{
      width:100%;
      padding:10px;
      border-radius:10px;
      border:1px solid #d1d5db;
      box-sizing:border-box;
      font-family: inherit;
    }
    textarea{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    button{
      font-weight:800;
      cursor:pointer;
      background:#fff;
    }
    .btnRow{ display:flex; gap:10px; margin-top:12px; }
    .btnSecondary{ background:#fff; }

    .row{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .radioGroup label{
      margin:6px 0;
      font-size:13px;
      color:#222;
      display:flex;
      gap:8px;
      align-items:center;
    }
    .radioGroup input[type="radio"]{ width:auto; }

    /* ===== Fix radio layout inside sidebar accordions ===== */
    .sidebar .radioGroup{
      display: grid;
      gap: 10px;
      margin-top: 10px;
    }

    .sidebar .radioGroup label{
      display: grid !important;
      grid-template-columns: 22px 1fr; /* radio + text */
      align-items: center;
      gap: 12px;
      margin: 0;
      font-size: 15px;
      line-height: 1.25;
      color: #111;
    }

    .sidebar .radioGroup input[type="radio"]{
      width: 18px !important;
      height: 18px !important;
      margin: 0;
      justify-self: start;
    }

    /* -------- Tables -------- */
    table{ width:100%; border-collapse:collapse; margin-top:10px; table-layout:auto; }
    th, td{ padding:8px; border-bottom:1px solid #f2f2f2; text-align:left; vertical-align:top; }
    th{ font-size:12px; color:#555; }

    .tblLabelCell { min-width: 260px; width: auto; }
    .tblDayCell   { width: 90px; }
    .tblAmtCell   { width: 130px; }
    .tblDateCell  { width: 170px; }
    .tblActCell   { width: 110px; }
    .tblLabelInput { width: 100%; }

    .pill{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      background:#f2f2f2;
      font-size:12px;
      color:#555;
      margin-left:8px;
      vertical-align:middle;
      font-weight:700;
    }

    .small{ font-size:12px; color:var(--muted); }
    .error{ color:var(--err); font-size:12px; margin-top:10px; white-space:pre-wrap; }
    hr{ border:none; border-top:1px solid var(--border); margin:14px 0; }

    /* ===== Sidebar table spacing fix ===== */
    .sidebar .accPanel table{
      width: 100%;
      table-layout: fixed;
    }

    .sidebar .accPanel th,
    .sidebar .accPanel td{
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .sidebar .accPanel .tblLabelCell { min-width: 0; width: 46%; }
    .sidebar .accPanel .tblDayCell   { width: 12%; }
    .sidebar .accPanel .tblAmtCell   { width: 16%; }
    .sidebar .accPanel .tblDateCell  { width: 18%; }
    .sidebar .accPanel .tblActCell   { width: 8%; }

    .sidebar .accPanel input,
    .sidebar .accPanel select{
      min-width: 0;
      width: 100%;
    }

    .sidebar .accPanel table input{
      padding: 8px;
      border-radius: 10px;
    }

    .sidebar .accPanel table{
      display: block;
      overflow-x: auto;
    }
  </style>
</head>

<body>
  <div id="cashflow-app"></div>

<script>
class CashflowTrajectory {
  constructor(mount, options = {}) {
    this.mount = typeof mount === "string" ? document.querySelector(mount) : mount;
    if (!this.mount) throw new Error("Mount element not found.");

    this.onUpdate = typeof options.onUpdate === "function" ? options.onUpdate : null;

    const baseDefaults = {
      startDate: "2026-01-01",
      endDate: "2026-12-31",
      todayDate: this.#todayISO(),
      startingAmount: 0,

      chartRange: "ALL", // 1D,1W,1M,3M,YTD,1Y,ALL

      income: {
        type: "biweekly",
        biweekly: { label: "Paycheck", firstPayday: "2026-01-02", amount: 1500 },
        weekly:   { label: "Paycheck", weekday: "Friday", amount: 750 },
        irregular: []
      },

      additionalIncome: [],

      monthlyEvents: [
        { label: "Rent",        day: 1,  amount: -1000, startDate: "2026-02-01" },
        { label: "Car payment", day: 15, amount: -700,  startDate: "2026-01-15" }
      ],

      discretionarySpending: [
        // { label: "Groceries", day: 5, amount: -300, startDate: "2026-01-05" }
      ]
    };

    this.defaults = this.#deepMerge(structuredClone(baseDefaults), options.defaults ?? {});
    this.state = structuredClone(this.defaults);

    this.chart = null;
    this.rows = [];

    this.#render();
    this.update();
  }

  // ---------- Public API ----------
  setConfig(partial) {
    this.state = this.#deepMerge(this.state, partial);
    this.#syncUIFromState();
    this.#renderIrregularPayTable();
    this.#renderMonthlyEventsTable();
    this.#renderDiscretionaryTable();
    this.#renderAdditionalIncomeTypeField();
    this.#renderAdditionalIncomeTable();
    this.#toggleIncomeUI();
    this.#refreshProfileDropdown();
    this.update();
  }

  getConfig() { return this.#readConfigFromUI(); }

  update() {
    const ui = this.#refs();
    try {
      ui.error.textContent = "";
      const cfg = this.#readConfigFromUI();

      const rows = this.#buildDataset(cfg);
      this.rows = rows;

      this.#renderPreview(rows, cfg);

      const chartRows = this.#sliceRowsForChartRange(rows, cfg);
      this.#renderChart(chartRows, cfg);

      if (this.onUpdate) this.onUpdate(rows, cfg);
    } catch (err) {
      ui.error.textContent = String(err?.message ?? err);
    }
  }

  // ---------- Render ----------
  #render() {
    this.mount.innerHTML = `
      <div class="dashboard">
        <!-- LEFT -->
        <div>
          <div class="mainTitle">Financial Wellness Trajectory</div>

          <div class="bigValue" id="cf-balanceBig">$0.00</div>
          <div class="deltaRow">
            <span id="cf-deltaToday" class="deltaUp">▲ $0.00</span>
            <span>Today</span>
          </div>

          <div class="chartWrap">
            <canvas id="cf-chart" height="120"></canvas>
          </div>

          <div class="rangeTabs" id="cf-rangeTabs">
            <button type="button" data-range="1D">1D</button>
            <button type="button" data-range="1W">1W</button>
            <button type="button" data-range="1M">1M</button>
            <button type="button" data-range="3M">3M</button>
            <button type="button" data-range="YTD">YTD</button>
            <button type="button" data-range="1Y">1Y</button>
            <button type="button" data-range="ALL">ALL</button>
          </div>

          <div class="hint" id="cf-summary" style="margin-top:14px;"></div>

          <!-- ✅ NEW: Monthly Forecast Summary -->
          <div class="forecastWrap" id="cf-forecast"></div>

          <div class="scrollBox">
            <pre id="cf-preview"></pre>
          </div>
        </div>

        <!-- RIGHT SIDEBAR -->
        <aside class="sidebar">
          <div class="sidebarTop">
            <div>Monthly Configurations</div>
            <div style="font-size:24px; font-weight:900;">+</div>
          </div>

          <div class="accItem open">
            <button class="accBtn" type="button">PRIMARY INCOME <span>⌄</span></button>
            <div class="accPanel">

              <div class="row">
                <div>
                  <label>Start date</label>
                  <input id="cf-startDate" type="date" />
                </div>
                <div>
                  <label>End date</label>
                  <input id="cf-endDate" type="date" />
                </div>
              </div>

              <div class="row">
                <div>
                  <label>Starting balance ($)</label>
                  <input id="cf-startingAmount" type="number" step="100" />
                </div>
                <div>
                  <label>Today’s date</label>
                  <input id="cf-todayDate" type="date" />
                  <div class="hint">Ends range windows on this date.</div>
                </div>
              </div>

              <hr />

              <h4 style="margin:0;">Income <span class="pill" id="cf-incomePill"></span></h4>
              <div class="hint">Choose how you get paid. The chart updates automatically.</div>

              <div class="radioGroup" style="margin-top:10px;">
                <label><input type="radio" name="cf-incomeType" value="biweekly" /> Bi-weekly paycheck</label>
                <label><input type="radio" name="cf-incomeType" value="weekly" /> Weekly paycheck</label>
                <label><input type="radio" name="cf-incomeType" value="irregular" /> Paid per job / irregular income</label>
              </div>

              <div id="cf-income-biweekly" style="margin-top:12px;">
                <div>
                  <label>Pay label</label>
                  <input id="cf-biweeklyLabel" type="text" placeholder="e.g. Paycheck" />
                </div>
                <div class="row">
                  <div>
                    <label>First paycheck date</label>
                    <input id="cf-biweeklyDate" type="date" />
                    <div class="hint">Every 14 days after this date is a payday.</div>
                  </div>
                  <div>
                    <label>Paycheck amount</label>
                    <input id="cf-biweeklyAmount" type="number" step="50" />
                  </div>
                </div>
              </div>

              <div id="cf-income-weekly" style="display:none; margin-top:12px;">
                <div>
                  <label>Pay label</label>
                  <input id="cf-weeklyLabel" type="text" placeholder="e.g. Paycheck" />
                </div>
                <div class="row">
                  <div>
                    <label>Paid on</label>
                    <select id="cf-weeklyDay">
                      <option>Monday</option><option>Tuesday</option><option>Wednesday</option>
                      <option>Thursday</option><option>Friday</option>
                      <option>Saturday</option><option>Sunday</option>
                    </select>
                  </div>
                  <div>
                    <label>Weekly pay amount</label>
                    <input id="cf-weeklyAmount" type="number" step="50" />
                  </div>
                </div>
              </div>

              <div id="cf-income-irregular" style="display:none; margin-top:12px;">
                <div>
                  <label>Description</label>
                  <input id="cf-irregLabel" type="text" placeholder="e.g. Client A – Website, Bonus" />
                </div>
                <div class="row">
                  <div>
                    <label>Pay date</label>
                    <input id="cf-irregDate" type="date" />
                  </div>
                  <div>
                    <label>Amount</label>
                    <input id="cf-irregAmount" type="number" step="50" />
                  </div>
                </div>

                <div class="btnRow" style="margin-top:10px;">
                  <button id="cf-addPayBtn" type="button">Add paycheck</button>
                  <button id="cf-clearPaysBtn" class="btnSecondary" type="button">Clear list</button>
                </div>

                <table>
                  <thead>
                    <tr>
                      <th class="tblLabelCell">Description</th>
                      <th style="width:170px;">Date</th>
                      <th class="tblAmtCell">Amount</th>
                      <th class="tblActCell">Action</th>
                    </tr>
                  </thead>
                  <tbody id="cf-payTable"></tbody>
                </table>
                <div class="hint">Tip: Add as many upcoming jobs/checks as you want.</div>
              </div>

            </div>
          </div>

          <div class="accItem">
            <button class="accBtn" type="button">ADDITIONAL INCOME ITEMS <span>⌄</span></button>
            <div class="accPanel">

              <div class="hint">Add extra income sources in addition to your main paycheck.</div>

              <div class="row">
                <div>
                  <label>Label</label>
                  <input id="cf-aiLabel" type="text" placeholder="e.g. Side gig, Bonus, Reimbursement" />
                </div>
                <div>
                  <label>Amount</label>
                  <input id="cf-aiAmount" type="number" step="50" placeholder="e.g. 250" />
                </div>
              </div>

              <div class="row">
                <div>
                  <label>Type</label>
                  <select id="cf-aiType">
                    <option value="one_time">One-time (date)</option>
                    <option value="weekly">Weekly (weekday)</option>
                    <option value="monthly">Monthly (day of month)</option>
                  </select>
                </div>
                <div id="cf-aiTypeField"></div>
              </div>

              <div class="btnRow">
                <button id="cf-aiAddBtn" type="button">Add income item</button>
                <button id="cf-aiClearBtn" class="btnSecondary" type="button">Clear items</button>
              </div>

              <table>
                <thead>
                  <tr>
                    <th class="tblLabelCell">Label</th>
                    <th class="tblAmtCell">Amount</th>
                    <th style="width:160px;">Type</th>
                    <th style="width:220px;">Rule</th>
                    <th class="tblActCell">Action</th>
                  </tr>
                </thead>
                <tbody id="cf-aiTable"></tbody>
              </table>

            </div>
          </div>

          <div class="accItem">
            <button class="accBtn" type="button">FIXED EXPENSES <span>⌄</span></button>
            <div class="accPanel">

              <div class="hint">Add recurring monthly debits/credits (rent, subscriptions, transfers, etc.).</div>

              <div>
                <label>Event label</label>
                <input id="cf-newEventLabel" type="text" placeholder="e.g. Rent, Car payment" />
              </div>

              <div class="row">
                <div>
                  <label>Day of month</label>
                  <input id="cf-newEventDay" type="number" min="1" max="31" value="15" />
                </div>
                <div>
                  <label>Amount (+ deposit / - debit)</label>
                  <input id="cf-newEventAmount" type="number" step="50" value="-700" />
                </div>
              </div>

              <div class="row">
                <div>
                  <label>Start date</label>
                  <input id="cf-newEventStart" type="date" />
                </div>
                <div style="display:flex; align-items:end;">
                  <button id="cf-addEventBtn" type="button">Add event</button>
                </div>
              </div>

              <table>
                <thead>
                  <tr>
                    <th class="tblLabelCell">Label</th>
                    <th class="tblDayCell">Day</th>
                    <th class="tblAmtCell">Amount</th>
                    <th class="tblDateCell">Start date</th>
                    <th class="tblActCell">Action</th>
                  </tr>
                </thead>
                <tbody id="cf-eventsTbody"></tbody>
              </table>

            </div>
          </div>

          <div class="accItem">
            <button class="accBtn" type="button">DISCRETIONARY SPENDING <span>⌄</span></button>
            <div class="accPanel">

              <div class="hint">Add recurring monthly “budget spending” items (groceries, gas, eating out, etc.).</div>

              <div>
                <label>Category label</label>
                <input id="cf-newSpendLabel" type="text" placeholder="e.g. Groceries, Gas, Restaurants" />
              </div>

              <div class="row">
                <div>
                  <label>Day of month</label>
                  <input id="cf-newSpendDay" type="number" min="1" max="31" value="1" />
                </div>
                <div>
                  <label>Amount (use negative for spending)</label>
                  <input id="cf-newSpendAmount" type="number" step="50" value="-300" />
                </div>
              </div>

              <div class="row">
                <div>
                  <label>Start date</label>
                  <input id="cf-newSpendStart" type="date" />
                </div>
                <div style="display:flex; align-items:end;">
                  <button id="cf-addSpendBtn" type="button">Add category</button>
                </div>
              </div>

              <table>
                <thead>
                  <tr>
                    <th class="tblLabelCell">Label</th>
                    <th class="tblDayCell">Day</th>
                    <th class="tblAmtCell">Amount</th>
                    <th class="tblDateCell">Start date</th>
                    <th class="tblActCell">Action</th>
                  </tr>
                </thead>
                <tbody id="cf-spendTbody"></tbody>
              </table>

            </div>
          </div>

          <div class="accItem">
            <button class="accBtn" type="button">SAVED PROFILES <span>⌄</span></button>
            <div class="accPanel">

              <div class="row">
                <div>
                  <label for="cf-profileName">Profile name</label>
                  <input id="cf-profileName" type="text" placeholder="e.g. Baseline, Paycheck v2" />
                </div>
                <div>
                  <label for="cf-profileSelect">Saved profiles</label>
                  <select id="cf-profileSelect">
                    <option value="">(none saved)</option>
                  </select>
                </div>
              </div>

              <div class="btnRow">
                <button id="cf-saveProfileBtn" type="button">Save profile</button>
                <button id="cf-loadProfileBtn" type="button" class="btnSecondary">Load</button>
                <button id="cf-deleteProfileBtn" type="button" class="btnSecondary">Delete</button>
              </div>

              <div class="btnRow">
                <button id="cf-runBtn" type="button">Generate Chart</button>
                <button id="cf-resetBtn" type="button" class="btnSecondary">Reset</button>
              </div>

              <div id="cf-error" class="error"></div>
            </div>
          </div>

        </aside>
      </div>
    `;

    this.#syncUIFromState();
    this.#renderIrregularPayTable();
    this.#renderMonthlyEventsTable();
    this.#renderDiscretionaryTable();

    this.#renderAdditionalIncomeTypeField();
    this.#renderAdditionalIncomeTable();

    this.#wireEvents();
    this.#toggleIncomeUI();
    this.#refreshProfileDropdown();
  }

  // ---------- Events ----------
  #wireEvents() {
    const ui = this.#refs();

    // Accordion open/close
    this.mount.querySelectorAll(".accBtn").forEach(btn => {
      btn.addEventListener("click", () => {
        const item = btn.closest(".accItem");
        if (!item) return;
        item.classList.toggle("open");
      });
    });

    // Range tabs
    this.mount.querySelectorAll("#cf-rangeTabs button").forEach(b => {
      b.addEventListener("click", () => {
        const r = b.dataset.range;
        this.state.chartRange = r;

        this.mount.querySelectorAll("#cf-rangeTabs button").forEach(x => x.classList.remove("active"));
        b.classList.add("active");

        this.update();
      });
    });

    [ui.startDate, ui.endDate, ui.todayDate, ui.startingAmount].forEach(el =>
      el.addEventListener("change", () => this.update())
    );

    ui.incomeRadios.forEach(r => {
      r.addEventListener("change", () => {
        this.state.income.type = r.value;
        this.#toggleIncomeUI();
        this.update();
      });
    });

    [ui.biweeklyLabel, ui.biweeklyDate, ui.biweeklyAmount].forEach(el =>
      el.addEventListener("change", () => this.update())
    );

    [ui.weeklyLabel, ui.weeklyDay, ui.weeklyAmount].forEach(el =>
      el.addEventListener("change", () => this.update())
    );

    ui.addPayBtn.addEventListener("click", () => {
      try { ui.error.textContent = ""; this.#addIrregularPayFromInputs(); this.update(); }
      catch (err) { ui.error.textContent = String(err?.message ?? err); }
    });

    ui.clearPaysBtn.addEventListener("click", () => {
      this.state.income.irregular = [];
      this.#renderIrregularPayTable();
      this.update();
    });

    ui.payTableBody.addEventListener("click", (e) => {
      const btn = e.target;
      if (btn?.dataset?.action !== "removePay") return;
      const idx = Number(btn.dataset.idx);
      if (!Number.isFinite(idx)) return;
      this.state.income.irregular.splice(idx, 1);
      this.#renderIrregularPayTable();
      this.update();
    });

    // Additional Income UI
    ui.aiType.addEventListener("change", () => this.#renderAdditionalIncomeTypeField());

    ui.aiAddBtn.addEventListener("click", () => {
      try { ui.error.textContent = ""; this.#addAdditionalIncomeFromInputs(); this.update(); }
      catch (err) { ui.error.textContent = String(err?.message ?? err); }
    });

    ui.aiClearBtn.addEventListener("click", () => {
      this.state.additionalIncome = [];
      this.#renderAdditionalIncomeTable();
      this.update();
    });

    ui.aiTable.addEventListener("click", (e) => {
      const btn = e.target;
      if (btn?.dataset?.action !== "aiRemove") return;
      const idx = Number(btn.dataset.idx);
      if (!Number.isFinite(idx)) return;
      this.state.additionalIncome.splice(idx, 1);
      this.#renderAdditionalIncomeTable();
      this.update();
    });

    // Fixed expenses
    ui.addEventBtn.addEventListener("click", () => {
      try { ui.error.textContent = ""; this.#addMonthlyEventFromInputs(); this.#renderMonthlyEventsTable(); this.update(); }
      catch (err) { ui.error.textContent = String(err?.message ?? err); }
    });

    ui.eventsTbody.addEventListener("change", (e) => {
      const el = e.target;
      const idx = Number(el?.dataset?.idx);
      const field = el?.dataset?.field;
      if (!Number.isFinite(idx) || !field) return;

      const ev = this.state.monthlyEvents[idx];
      if (!ev) return;

      if (field === "label") ev.label = el.value;
      if (field === "day") ev.day = Number(el.value);
      if (field === "amount") ev.amount = Number(el.value);
      if (field === "startDate") ev.startDate = el.value;

      this.update();
    });

    ui.eventsTbody.addEventListener("click", (e) => {
      const btn = e.target;
      if (btn?.dataset?.action !== "removeEvent") return;
      const idx = Number(btn.dataset.idx);
      if (!Number.isFinite(idx)) return;
      this.state.monthlyEvents.splice(idx, 1);
      this.#renderMonthlyEventsTable();
      this.update();
    });

    // Discretionary spending
    ui.addSpendBtn?.addEventListener("click", () => {
      try {
        ui.error.textContent = "";
        this.#addDiscretionaryFromInputs();
        this.#renderDiscretionaryTable();
        this.update();
      } catch (err) {
        ui.error.textContent = String(err?.message ?? err);
      }
    });

    ui.spendTbody?.addEventListener("change", (e) => {
      const el = e.target;
      const idx = Number(el?.dataset?.idx);
      const field = el?.dataset?.field;
      if (!Number.isFinite(idx) || !field) return;

      const it = this.state.discretionarySpending[idx];
      if (!it) return;

      if (field === "label") it.label = el.value;
      if (field === "day") it.day = Number(el.value);
      if (field === "amount") it.amount = Number(el.value);
      if (field === "startDate") it.startDate = el.value;

      this.update();
    });

    ui.spendTbody?.addEventListener("click", (e) => {
      const btn = e.target;
      if (btn?.dataset?.action !== "removeSpend") return;
      const idx = Number(btn.dataset.idx);
      if (!Number.isFinite(idx)) return;

      this.state.discretionarySpending.splice(idx, 1);
      this.#renderDiscretionaryTable();
      this.update();
    });

    // Profiles
    ui.profileSelect?.addEventListener("change", () => {
      if (ui.profileName) ui.profileName.value = ui.profileSelect.value || "";
    });

    ui.saveProfileBtn?.addEventListener("click", () => {
      try {
        ui.error.textContent = "";
        this.#saveProfile(ui.profileName?.value);
        const n = (ui.profileName?.value ?? "").trim();
        if (n) ui.profileSelect.value = n;
      } catch (err) {
        ui.error.textContent = String(err?.message ?? err);
      }
    });

    ui.loadProfileBtn?.addEventListener("click", () => {
      try { ui.error.textContent = ""; this.#loadProfile(ui.profileSelect?.value); }
      catch (err) { ui.error.textContent = String(err?.message ?? err); }
    });

    ui.deleteProfileBtn?.addEventListener("click", () => {
      try {
        ui.error.textContent = "";
        this.#deleteProfile(ui.profileSelect?.value);
        if (ui.profileName) ui.profileName.value = "";
      } catch (err) {
        ui.error.textContent = String(err?.message ?? err);
      }
    });

    ui.runBtn.addEventListener("click", () => this.update());
    ui.resetBtn.addEventListener("click", () => {
      this.state = structuredClone(this.defaults);
      this.#syncUIFromState();
      this.#renderIrregularPayTable();
      this.#renderMonthlyEventsTable();
      this.#renderDiscretionaryTable();
      this.#renderAdditionalIncomeTypeField();
      this.#renderAdditionalIncomeTable();
      this.#toggleIncomeUI();
      this.#refreshProfileDropdown();
      this.update();
    });
  }

  #toggleIncomeUI() {
    const ui = this.#refs();
    const type = this.state.income.type;

    ui.incomePill.textContent = type === "biweekly" ? "Bi-weekly" : (type === "weekly" ? "Weekly" : "Irregular");
    ui.sectionBiweekly.style.display = type === "biweekly" ? "" : "none";
    ui.sectionWeekly.style.display   = type === "weekly"   ? "" : "none";
    ui.sectionIrregular.style.display= type === "irregular" ? "" : "none";
    ui.incomeRadios.forEach(r => r.checked = (r.value === type));
  }

  // ---------- Saved Profiles (LocalStorage) ----------
  #profileKey(name) { return `cf_profile_v1:${name}`; }

  #listProfiles() {
    return Object.keys(localStorage)
      .filter(k => k.startsWith("cf_profile_v1:"))
      .map(k => k.replace("cf_profile_v1:", ""))
      .sort((a, b) => a.localeCompare(b));
  }

  #refreshProfileDropdown() {
    const ui = this.#refs();
    if (!ui.profileSelect) return;

    const names = this.#listProfiles();
    ui.profileSelect.innerHTML = names.length
      ? names.map(n => `<option value="${this.#escapeAttr(n)}">${this.#escapeHtml(n)}</option>`).join("")
      : `<option value="">(none saved)</option>`;
  }

  #saveProfile(name) {
    const n = String(name ?? "").trim();
    if (!n) throw new Error("Profile name is required.");
    const cfg = this.getConfig();
    localStorage.setItem(this.#profileKey(n), JSON.stringify(cfg));
    this.#refreshProfileDropdown();
  }

  #loadProfile(name) {
    const n = String(name ?? "").trim();
    if (!n) throw new Error("Choose a profile to load.");
    const raw = localStorage.getItem(this.#profileKey(n));
    if (!raw) throw new Error("Profile not found.");
    const cfg = JSON.parse(raw);
    this.setConfig(cfg);
  }

  #deleteProfile(name) {
    const n = String(name ?? "").trim();
    if (!n) throw new Error("Choose a profile to delete.");
    localStorage.removeItem(this.#profileKey(n));
    this.#refreshProfileDropdown();
  }

  // ---------- Irregular Income ----------
  #addIrregularPayFromInputs() {
    const ui = this.#refs();
    const label = ui.irregLabel.value.trim() || "Income";
    const date = ui.irregDate.value;
    const amount = Number(ui.irregAmount.value);

    if (!date) throw new Error("Pay date is required.");
    if (!Number.isFinite(amount)) throw new Error("Pay amount must be a number.");

    this.state.income.irregular.push({ label, date, amount });
    this.state.income.irregular.sort((a, b) => a.date.localeCompare(b.date));

    ui.irregLabel.value = "";
    ui.irregAmount.value = "";
    this.#renderIrregularPayTable();
  }

  #renderIrregularPayTable() {
    const ui = this.#refs();
    const pays = this.state.income.irregular ?? [];

    if (!pays.length) {
      ui.payTableBody.innerHTML = `<tr><td colspan="4" class="small">No paychecks added yet.</td></tr>`;
      return;
    }

    ui.payTableBody.innerHTML = pays.map((p, idx) => `
      <tr>
        <td class="tblLabelCell">${this.#escapeHtml(p.label)}</td>
        <td>${this.#escapeHtml(p.date)}</td>
        <td>$${Number(p.amount).toLocaleString()}</td>
        <td><button type="button" data-action="removePay" data-idx="${idx}">Remove</button></td>
      </tr>
    `).join("");
  }

  // ---------- Additional Income ----------
  #renderAdditionalIncomeTypeField() {
    const ui = this.#refs();
    const type = ui.aiType.value;

    if (type === "one_time") {
      ui.aiTypeField.innerHTML = `
        <label>Date</label>
        <input id="cf-aiDate" type="date" />
      `;
    } else if (type === "weekly") {
      ui.aiTypeField.innerHTML = `
        <label>Weekday + start date</label>
        <div class="row">
          <select id="cf-aiWeekday">
            <option>Monday</option><option>Tuesday</option><option>Wednesday</option>
            <option>Thursday</option><option>Friday</option>
            <option>Saturday</option><option>Sunday</option>
          </select>
          <input id="cf-aiStart" type="date" />
        </div>
      `;
    } else {
      ui.aiTypeField.innerHTML = `
        <label>Day of month + start date</label>
        <div class="row">
          <input id="cf-aiDay" type="number" min="1" max="31" value="1" />
          <input id="cf-aiStart" type="date" />
        </div>
      `;
    }

    const dateEl = this.mount.querySelector("#cf-aiDate");
    const startEl = this.mount.querySelector("#cf-aiStart");
    if (dateEl && !dateEl.value) dateEl.value = ui.startDate.value;
    if (startEl && !startEl.value) startEl.value = ui.startDate.value;
  }

  #addAdditionalIncomeFromInputs() {
    const ui = this.#refs();
    const label = ui.aiLabel.value.trim() || "Additional income";
    const amount = Number(ui.aiAmount.value);
    const type = ui.aiType.value;

    if (!Number.isFinite(amount)) throw new Error("Additional income amount must be a number.");

    if (type === "one_time") {
      const date = this.mount.querySelector("#cf-aiDate")?.value;
      if (!date) throw new Error("One-time income requires a date.");
      this.state.additionalIncome.push({ label, type, amount, date });
    } else if (type === "weekly") {
      const weekday = this.mount.querySelector("#cf-aiWeekday")?.value;
      const startDate = this.mount.querySelector("#cf-aiStart")?.value;
      if (!weekday || !startDate) throw new Error("Weekly income requires weekday and start date.");
      this.state.additionalIncome.push({ label, type, amount, weekday, startDate });
    } else {
      const day = Number(this.mount.querySelector("#cf-aiDay")?.value);
      const startDate = this.mount.querySelector("#cf-aiStart")?.value;
      if (!Number.isFinite(day) || day < 1 || day > 31) throw new Error("Monthly income day must be 1–31.");
      if (!startDate) throw new Error("Monthly income requires a start date.");
      this.state.additionalIncome.push({ label, type, amount, day, startDate });
    }

    ui.aiLabel.value = "";
    ui.aiAmount.value = "";
    this.#renderAdditionalIncomeTable();
  }

  #renderAdditionalIncomeTable() {
    const ui = this.#refs();
    const items = this.state.additionalIncome ?? [];

    if (!items.length) {
      ui.aiTable.innerHTML = `<tr><td colspan="5" class="small">No additional income items.</td></tr>`;
      return;
    }

    ui.aiTable.innerHTML = items.map((it, idx) => {
      const rule =
        it.type === "one_time" ? it.date :
        it.type === "weekly" ? `${it.weekday} (from ${it.startDate})` :
        `Day ${it.day} (from ${it.startDate})`;

      return `
        <tr>
          <td class="tblLabelCell">${this.#escapeHtml(it.label)}</td>
          <td class="tblAmtCell">$${Number(it.amount).toLocaleString()}</td>
          <td>${this.#escapeHtml(it.type)}</td>
          <td>${this.#escapeHtml(rule)}</td>
          <td class="tblActCell">
            <button type="button" data-action="aiRemove" data-idx="${idx}">Remove</button>
          </td>
        </tr>
      `;
    }).join("");
  }

  // ---------- Monthly Events ----------
  #addMonthlyEventFromInputs() {
    const ui = this.#refs();
    const label = ui.newEventLabel.value.trim() || "Monthly event";
    const day = Number(ui.newEventDay.value);
    const amount = Number(ui.newEventAmount.value);
    const startDate = ui.newEventStart.value;

    if (!Number.isFinite(day) || day < 1 || day > 31) throw new Error("Monthly event day must be 1–31.");
    if (!Number.isFinite(amount)) throw new Error("Monthly event amount must be a number.");
    if (!startDate) throw new Error("Monthly event start date is required.");

    this.state.monthlyEvents.push({ label, day, amount, startDate });
    ui.newEventLabel.value = "";
  }

  #renderMonthlyEventsTable() {
    const ui = this.#refs();
    const events = this.state.monthlyEvents ?? [];

    if (!events.length) {
      ui.eventsTbody.innerHTML = `<tr><td colspan="5" class="small">No monthly events yet. Add one above.</td></tr>`;
      return;
    }

    ui.eventsTbody.innerHTML = events.map((ev, idx) => `
      <tr>
        <td class="tblLabelCell">
          <input class="tblLabelInput" data-idx="${idx}" data-field="label" type="text"
                 value="${this.#escapeAttr(ev.label)}" />
        </td>
        <td class="tblDayCell">
          <input data-idx="${idx}" data-field="day" type="number" min="1" max="31"
                 value="${Number(ev.day)}" />
        </td>
        <td class="tblAmtCell">
          <input data-idx="${idx}" data-field="amount" type="number" step="50"
                 value="${Number(ev.amount)}" />
        </td>
        <td class="tblDateCell">
          <input data-idx="${idx}" data-field="startDate" type="date"
                 value="${this.#escapeAttr(ev.startDate)}" />
        </td>
        <td class="tblActCell">
          <button type="button" data-action="removeEvent" data-idx="${idx}">Remove</button>
        </td>
      </tr>
    `).join("");
  }

  // ---------- Discretionary Spending ----------
  #addDiscretionaryFromInputs() {
    const ui = this.#refs();
    const label = ui.newSpendLabel.value.trim() || "Discretionary spending";
    const day = Number(ui.newSpendDay.value);
    const amount = Number(ui.newSpendAmount.value);
    const startDate = ui.newSpendStart.value;

    if (!Number.isFinite(day) || day < 1 || day > 31) throw new Error("Spending day must be 1–31.");
    if (!Number.isFinite(amount)) throw new Error("Spending amount must be a number.");
    if (!startDate) throw new Error("Spending start date is required.");

    this.state.discretionarySpending.push({ label, day, amount, startDate });
    ui.newSpendLabel.value = "";
  }

  #renderDiscretionaryTable() {
    const ui = this.#refs();
    const items = this.state.discretionarySpending ?? [];
    if (!ui.spendTbody) return;

    if (!items.length) {
      ui.spendTbody.innerHTML = `<tr><td colspan="5" class="small">No discretionary categories yet. Add one above.</td></tr>`;
      return;
    }

    ui.spendTbody.innerHTML = items.map((it, idx) => `
      <tr>
        <td class="tblLabelCell">
          <input class="tblLabelInput" data-idx="${idx}" data-field="label" type="text"
                 value="${this.#escapeAttr(it.label)}" />
        </td>
        <td class="tblDayCell">
          <input data-idx="${idx}" data-field="day" type="number" min="1" max="31"
                 value="${Number(it.day)}" />
        </td>
        <td class="tblAmtCell">
          <input data-idx="${idx}" data-field="amount" type="number" step="50"
                 value="${Number(it.amount)}" />
        </td>
        <td class="tblDateCell">
          <input data-idx="${idx}" data-field="startDate" type="date"
                 value="${this.#escapeAttr(it.startDate)}" />
        </td>
        <td class="tblActCell">
          <button type="button" data-action="removeSpend" data-idx="${idx}">Remove</button>
        </td>
      </tr>
    `).join("");
  }

  // ---------- Dataset Engine ----------
  #buildDataset(cfg) {
    const start = this.#parseISO(cfg.startDate);
    const end = this.#parseISO(cfg.endDate);
    if (end < start) throw new Error("End date must be on/after start date.");
    const today = this.#parseISO(cfg.todayDate);

    let balance = Number(cfg.startingAmount);
    if (!Number.isFinite(balance)) throw new Error("Starting amount must be a number.");

    const monthlyEvents = (cfg.monthlyEvents ?? []).map((ev, i) => {
      const label = String(ev.label ?? "Monthly event");
      const day = Number(ev.day);
      const amount = Number(ev.amount);
      const startDate = this.#parseISO(ev.startDate);

      if (!Number.isFinite(day) || day < 1 || day > 31) throw new Error(`Monthly event #${i + 1}: day must be 1–31.`);
      if (!Number.isFinite(amount)) throw new Error(`Monthly event #${i + 1}: amount must be a number.`);
      return { label, day, amount, startDate };
    });

    const discretionary = (cfg.discretionarySpending ?? []).map((ev, i) => {
      const label = String(ev.label ?? "Discretionary spending");
      const day = Number(ev.day);
      const amount = Number(ev.amount);
      const startDate = this.#parseISO(ev.startDate);

      if (!Number.isFinite(day) || day < 1 || day > 31) throw new Error(`Discretionary item #${i + 1}: day must be 1–31.`);
      if (!Number.isFinite(amount)) throw new Error(`Discretionary item #${i + 1}: amount must be a number.`);
      return { label, day, amount, startDate };
    });

    const irregularMap = this.#irregularPaysToMap(cfg.income.irregular);

    const rows = [];
    for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
      const cur = new Date(d);
      const curISO = this.#toISODate(cur);
      let net = 0;
      const reasons = [];

      // Primary paycheck
      if (cfg.income.type === "biweekly") {
        const label = (cfg.income.biweekly.label || "Paycheck").trim() || "Paycheck";
        const fp = this.#parseISO(cfg.income.biweekly.firstPayday);
        const amt = Number(cfg.income.biweekly.amount);
        if (!Number.isFinite(amt)) throw new Error("Bi-weekly paycheck amount must be a number.");

        if (cur >= fp) {
          const diffDays = Math.floor((cur - fp) / 86400000);
          if (diffDays % 14 === 0) { net += amt; reasons.push(`${label}: +${amt}`); }
        }
      } else if (cfg.income.type === "weekly") {
        const label = (cfg.income.weekly.label || "Paycheck").trim() || "Paycheck";
        const amt = Number(cfg.income.weekly.amount);
        if (!Number.isFinite(amt)) throw new Error("Weekly pay amount must be a number.");

        if (this.#weekdayName(cur) === cfg.income.weekly.weekday) { net += amt; reasons.push(`${label}: +${amt}`); }
      } else if (cfg.income.type === "irregular") {
        const obj = irregularMap.get(curISO);
        if (obj) { net += obj.total; obj.labels.forEach(s => reasons.push(s)); }
      }

      // Additional income
      for (const it of (cfg.additionalIncome ?? [])) {
        if (it.type === "one_time" && curISO === it.date) { net += it.amount; reasons.push(`${it.label}: +${it.amount}`); }
        if (it.type === "weekly") {
          if (cur >= this.#parseISO(it.startDate) && this.#weekdayName(cur) === it.weekday) { net += it.amount; reasons.push(`${it.label}: +${it.amount}`); }
        }
        if (it.type === "monthly") {
          if (cur >= this.#parseISO(it.startDate) && cur.getDate() === Number(it.day)) { net += it.amount; reasons.push(`${it.label}: +${it.amount}`); }
        }
      }

      // Fixed monthly events
      for (const ev of monthlyEvents) {
        if (cur >= ev.startDate && cur.getDate() === ev.day) {
          net += ev.amount;
          reasons.push(`${ev.label}: ${ev.amount >= 0 ? "+" : ""}${ev.amount}`);
        }
      }

      // Discretionary spending
      for (const ev of discretionary) {
        if (cur >= ev.startDate && cur.getDate() === ev.day) {
          net += ev.amount;
          reasons.push(`${ev.label}: ${ev.amount >= 0 ? "+" : ""}${ev.amount}`);
        }
      }

      balance += net;

      rows.push({
        date: curISO,
        net_change: net,
        eod_balance: balance,
        reasons,
        is_today: curISO === this.#toISODate(today)
      });
    }

    return rows;
  }

  #irregularPaysToMap(pays) {
    const map = new Map();
    (pays ?? []).forEach((p, i) => {
      if (!p.date) throw new Error(`Irregular paycheck #${i + 1}: date required.`);
      const date = this.#parseISO(p.date);
      const amt = Number(p.amount);
      if (!Number.isFinite(amt)) throw new Error(`Irregular paycheck #${i + 1}: amount must be a number.`);

      const iso = this.#toISODate(date);
      const label = String(p.label ?? "Income").trim() || "Income";
      const labelLine = `${label}: ${amt >= 0 ? "+" : ""}${amt}`;

      const cur = map.get(iso) ?? { total: 0, labels: [] };
      cur.total += amt;
      cur.labels.push(labelLine);
      map.set(iso, cur);
    });
    return map;
  }

  // ---------- Range Slicing ----------
  #sliceRowsForChartRange(rows, cfg) {
    const range = String(cfg.chartRange ?? "ALL").toUpperCase();
    if (range === "ALL") return rows;

    const todayISO = this.#toISODate(this.#parseISO(cfg.todayDate));
    const todayIdx = rows.findIndex(r => r.date === todayISO);
    const endIdx = todayIdx >= 0 ? todayIdx : (rows.length - 1);
    const endDate = this.#parseISO(rows[endIdx].date);

    if (range === "YTD") {
      const jan1 = new Date(endDate.getFullYear(), 0, 1);
      const startIdx = rows.findIndex(r => this.#parseISO(r.date) >= jan1);
      return rows.slice(Math.max(0, startIdx), endIdx + 1);
    }

    const days =
      range === "1D" ? 1 :
      range === "1W" ? 7 :
      range === "1M" ? 30 :
      range === "3M" ? 90 :
      range === "1Y" ? 365 : rows.length;

    const startIdx = Math.max(0, endIdx - (days - 1));
    return rows.slice(startIdx, endIdx + 1);
  }

  // ---------- Preview + Chart ----------
  #renderPreview(rows, cfg) {
    const ui = this.#refs();

    ui.preview.textContent = rows.map(r => {
      const reasons = (r.reasons?.length ? " | " + r.reasons.join("; ") : "");
      return `${r.date} | net ${r.net_change >= 0 ? "+" : ""}${r.net_change} | balance $${r.eod_balance.toLocaleString()}${reasons}`;
    }).join("\n");

    const final = rows[rows.length - 1];
    const todayRow = rows.find(r => r.is_today);
    const todayText = todayRow ? ` • Today: $${todayRow.eod_balance.toLocaleString()} (${todayRow.date})` : "";
    ui.summary.textContent =
      `Rows: ${rows.length.toLocaleString()} • Final: $${final.eod_balance.toLocaleString()} • Start: $${Number(cfg.startingAmount).toLocaleString()}${todayText}`;

    const anchor = todayRow ?? final;
    const big = this.mount.querySelector("#cf-balanceBig");
    if (big) big.textContent = `$${Number(anchor.eod_balance).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

    const deltaEl = this.mount.querySelector("#cf-deltaToday");
    if (deltaEl) {
      const anchorIdx = rows.findIndex(r => r.date === anchor.date);
      const prev = anchorIdx > 0 ? rows[anchorIdx - 1].eod_balance : anchor.eod_balance;
      const diff = Number(anchor.eod_balance) - Number(prev);

      const sign = diff >= 0 ? "▲" : "▼";
      const txt = `${sign} $${Math.abs(diff).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
      deltaEl.textContent = txt;

      deltaEl.classList.toggle("deltaUp", diff >= 0);
      deltaEl.classList.toggle("deltaDown", diff < 0);
    }

    // ✅ NEW: Always-visible monthly forecast summary (Posted vs Scheduled, plus full-month totals)
    this.#renderMonthlyForecast(rows, cfg);
  }

  // ---------- Monthly Forecast Summary (NEW) ----------
  #renderMonthlyForecast(rows, cfg) {
    const box = this.mount.querySelector("#cf-forecast");
    if (!box) return;

    const today = this.#parseISO(cfg.todayDate);
    const ym = { y: today.getFullYear(), m: today.getMonth() };

    const monthRows = rows.filter(r => {
      const d = this.#parseISO(r.date);
      return d.getFullYear() === ym.y && d.getMonth() === ym.m;
    });

    const totals = this.#buildBreakdown(monthRows, today);

    const monthName = this.#monthName(ym.m);
    const monthLabel = `${monthName} ${ym.y}`;
    const todayISO = this.#toISODate(today);

    const topIncome = this.#topItems(totals.full.incomeByLabel, 6, true);
    const topExpense = this.#topItems(totals.full.expenseByLabel, 6, false);

    const money = (n) => `$${Math.abs(Number(n)).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    const signedMoney = (n) => `$${Number(n).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

    const netClass = totals.full.net >= 0 ? "netGood" : "netBad";
    const remNetClass = totals.remaining.net >= 0 ? "netGood" : "netBad";
    const postedNetClass = totals.posted.net >= 0 ? "netGood" : "netBad";

    box.innerHTML = `
      <div class="forecastHead">
        <div class="forecastTitle">Monthly forecast</div>
        <div class="forecastMeta">${this.#escapeHtml(monthLabel)} • anchored on ${this.#escapeHtml(todayISO)}</div>
      </div>

      <div class="forecastGrid">
        <div class="forecastBox">
          <h4>Where it’s coming from</h4>
          <ul class="forecastList">
            ${topIncome.length ? topIncome.map(([k, v]) => `
              <li class="forecastItem">
                <span class="lbl" title="${this.#escapeAttr(k)}">${this.#escapeHtml(k)}</span>
                <span class="amt in">${money(v)}</span>
              </li>
            `).join("") : `<li class="small">No income events in this month.</li>`}
          </ul>
        </div>

        <div class="forecastBox">
          <h4>Where it’s going</h4>
          <ul class="forecastList">
            ${topExpense.length ? topExpense.map(([k, v]) => `
              <li class="forecastItem">
                <span class="lbl" title="${this.#escapeAttr(k)}">${this.#escapeHtml(k)}</span>
                <span class="amt out">${money(v)}</span>
              </li>
            `).join("") : `<li class="small">No expense events in this month.</li>`}
          </ul>
        </div>

        <div class="forecastTotals">
          <div class="totRow">
            <span>Total income (month)</span>
            <span class="val netGood">${signedMoney(totals.full.income)}</span>
          </div>
          <div class="totRow">
            <span>Total expenses (month)</span>
            <span class="val netBad">${signedMoney(totals.full.expenses)}</span>
          </div>
          <div class="totRow">
            <span>Projected net (month)</span>
            <span class="val ${netClass}">${signedMoney(totals.full.net)}</span>
          </div>
          <div class="totRow">
            <span>Posted so far <small>(≤ today)</small></span>
            <span class="val ${postedNetClass}">${signedMoney(totals.posted.net)}</span>
          </div>
          <div class="totRow">
            <span>Still scheduled <small>(after today)</small></span>
            <span class="val ${remNetClass}">${signedMoney(totals.remaining.net)}</span>
          </div>
        </div>

        <div class="forecastNote">
          Tip: This summary includes the entire month (posted + scheduled). It updates as you change “Today’s date” and your income/expense rules.
        </div>
      </div>
    `;
  }

  #buildBreakdown(monthRows, todayDate) {
    const initBucket = () => ({
      income: 0,
      expenses: 0,
      net: 0,
      incomeByLabel: {},
      expenseByLabel: {}
    });

    const full = initBucket();
    const posted = initBucket();
    const remaining = initBucket();

    const todayISO = this.#toISODate(todayDate);

    for (const r of (monthRows ?? [])) {
      const bucket = (r.date <= todayISO) ? posted : remaining;

      for (const reason of (r.reasons ?? [])) {
        const parsed = this.#parseReason(reason);
        if (!parsed) continue;
        const { label, amount } = parsed;

        this.#applyToBucket(full, label, amount);
        this.#applyToBucket(bucket, label, amount);
      }
    }

    return { full, posted, remaining };
  }

  #applyToBucket(bucket, label, amount) {
    bucket.net += amount;
    if (amount >= 0) {
      bucket.income += amount;
      bucket.incomeByLabel[label] = (bucket.incomeByLabel[label] ?? 0) + amount;
    } else {
      bucket.expenses += amount; // stays negative
      bucket.expenseByLabel[label] = (bucket.expenseByLabel[label] ?? 0) + amount; // negative
    }
  }

  #parseReason(reasonStr) {
    const s = String(reasonStr ?? "").trim();
    const idx = s.indexOf(":");
    if (idx < 0) return null;

    const label = s.slice(0, idx).trim() || "Item";
    const amtRaw = s.slice(idx + 1).trim().replaceAll(",", "");
    const amount = Number(amtRaw);
    if (!Number.isFinite(amount)) return null;

    return { label, amount };
  }

  #topItems(mapObj, limit = 6, positive = true) {
    const entries = Object.entries(mapObj ?? {});
    const sorted = entries.sort((a, b) => Math.abs(Number(b[1])) - Math.abs(Number(a[1])));
    const sliced = sorted.slice(0, limit);

    // for expenses we keep negative values in map; for display we show absolute anyway
    return positive ? sliced : sliced;
  }

  #monthName(mIdx) {
    const names = ["January","February","March","April","May","June","July","August","September","October","November","December"];
    return names[mIdx] ?? "Month";
  }

  // GREEN LINE ONLY
  #renderChart(rows, cfg) {
    const ui = this.#refs();
    const labels = rows.map(r => r.date);
    const balances = rows.map(r => r.eod_balance);

    if (this.chart) this.chart.destroy();

    this.chart = new Chart(ui.canvas, {
      type: "line",
      data: {
        labels,
        datasets: [
          {
            label: "End-of-Day Balance",
            data: balances,
            borderWidth: 3,
            pointRadius: 0,
            tension: 0.12,
            borderColor: "#16a34a"
          }
        ]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: (ctx) => `$${Number(ctx.parsed.y).toLocaleString()}`,
              afterBody: (items) => {
                const i = items?.[0]?.dataIndex;
                const r = rows?.[i];
                if (!r?.reasons?.length) return "";
                return r.reasons.join("\n");
              }
            }
          }
        },
        interaction: { mode: "index", intersect: false },
        scales: {
          x: { ticks: { maxTicksLimit: 12 } },
          y: { ticks: { callback: (v) => `$${Number(v).toLocaleString()}` } }
        }
      }
    });
  }

  // ---------- Refs + Sync ----------
  #refs() {
    return {
      startDate: this.mount.querySelector("#cf-startDate"),
      endDate: this.mount.querySelector("#cf-endDate"),
      todayDate: this.mount.querySelector("#cf-todayDate"),
      startingAmount: this.mount.querySelector("#cf-startingAmount"),

      incomePill: this.mount.querySelector("#cf-incomePill"),
      incomeRadios: Array.from(this.mount.querySelectorAll('input[name="cf-incomeType"]')),

      sectionBiweekly: this.mount.querySelector("#cf-income-biweekly"),
      sectionWeekly: this.mount.querySelector("#cf-income-weekly"),
      sectionIrregular: this.mount.querySelector("#cf-income-irregular"),

      biweeklyLabel: this.mount.querySelector("#cf-biweeklyLabel"),
      biweeklyDate: this.mount.querySelector("#cf-biweeklyDate"),
      biweeklyAmount: this.mount.querySelector("#cf-biweeklyAmount"),

      weeklyLabel: this.mount.querySelector("#cf-weeklyLabel"),
      weeklyDay: this.mount.querySelector("#cf-weeklyDay"),
      weeklyAmount: this.mount.querySelector("#cf-weeklyAmount"),

      irregLabel: this.mount.querySelector("#cf-irregLabel"),
      irregDate: this.mount.querySelector("#cf-irregDate"),
      irregAmount: this.mount.querySelector("#cf-irregAmount"),
      addPayBtn: this.mount.querySelector("#cf-addPayBtn"),
      clearPaysBtn: this.mount.querySelector("#cf-clearPaysBtn"),
      payTableBody: this.mount.querySelector("#cf-payTable"),

      aiLabel: this.mount.querySelector("#cf-aiLabel"),
      aiAmount: this.mount.querySelector("#cf-aiAmount"),
      aiType: this.mount.querySelector("#cf-aiType"),
      aiTypeField: this.mount.querySelector("#cf-aiTypeField"),
      aiAddBtn: this.mount.querySelector("#cf-aiAddBtn"),
      aiClearBtn: this.mount.querySelector("#cf-aiClearBtn"),
      aiTable: this.mount.querySelector("#cf-aiTable"),

      newEventLabel: this.mount.querySelector("#cf-newEventLabel"),
      newEventDay: this.mount.querySelector("#cf-newEventDay"),
      newEventAmount: this.mount.querySelector("#cf-newEventAmount"),
      newEventStart: this.mount.querySelector("#cf-newEventStart"),
      addEventBtn: this.mount.querySelector("#cf-addEventBtn"),
      eventsTbody: this.mount.querySelector("#cf-eventsTbody"),

      newSpendLabel: this.mount.querySelector("#cf-newSpendLabel"),
      newSpendDay: this.mount.querySelector("#cf-newSpendDay"),
      newSpendAmount: this.mount.querySelector("#cf-newSpendAmount"),
      newSpendStart: this.mount.querySelector("#cf-newSpendStart"),
      addSpendBtn: this.mount.querySelector("#cf-addSpendBtn"),
      spendTbody: this.mount.querySelector("#cf-spendTbody"),

      profileName: this.mount.querySelector("#cf-profileName"),
      profileSelect: this.mount.querySelector("#cf-profileSelect"),
      saveProfileBtn: this.mount.querySelector("#cf-saveProfileBtn"),
      loadProfileBtn: this.mount.querySelector("#cf-loadProfileBtn"),
      deleteProfileBtn: this.mount.querySelector("#cf-deleteProfileBtn"),

      runBtn: this.mount.querySelector("#cf-runBtn"),
      resetBtn: this.mount.querySelector("#cf-resetBtn"),
      error: this.mount.querySelector("#cf-error"),

      preview: this.mount.querySelector("#cf-preview"),
      summary: this.mount.querySelector("#cf-summary"),
      canvas: this.mount.querySelector("#cf-chart")
    };
  }

  #syncUIFromState() {
    const ui = this.#refs();
    ui.startDate.value = this.state.startDate;
    ui.endDate.value = this.state.endDate;
    ui.todayDate.value = this.state.todayDate;
    ui.startingAmount.value = String(this.state.startingAmount);

    ui.incomeRadios.forEach(r => r.checked = (r.value === this.state.income.type));

    ui.biweeklyLabel.value = this.state.income.biweekly.label;
    ui.biweeklyDate.value = this.state.income.biweekly.firstPayday;
    ui.biweeklyAmount.value = String(this.state.income.biweekly.amount);

    ui.weeklyLabel.value = this.state.income.weekly.label;
    ui.weeklyDay.value = this.state.income.weekly.weekday;
    ui.weeklyAmount.value = String(this.state.income.weekly.amount);

    ui.irregDate.value = this.state.startDate;

    const r = String(this.state.chartRange ?? "ALL").toUpperCase();
    this.mount.querySelectorAll("#cf-rangeTabs button").forEach(x => {
      x.classList.toggle("active", x.dataset.range === r);
    });
  }

  #readConfigFromUI() {
    const ui = this.#refs();
    const selectedType = ui.incomeRadios.find(r => r.checked)?.value ?? this.state.income.type;
    this.state.income.type = selectedType;

    this.state.income.biweekly.label = ui.biweeklyLabel.value.trim() || "Paycheck";
    this.state.income.biweekly.firstPayday = ui.biweeklyDate.value;
    this.state.income.biweekly.amount = Number(ui.biweeklyAmount.value || 0);

    this.state.income.weekly.label = ui.weeklyLabel.value.trim() || "Paycheck";
    this.state.income.weekly.weekday = ui.weeklyDay.value;
    this.state.income.weekly.amount = Number(ui.weeklyAmount.value || 0);

    return {
      startDate: ui.startDate.value,
      endDate: ui.endDate.value,
      todayDate: ui.todayDate.value,
      startingAmount: Number(ui.startingAmount.value || 0),
      income: structuredClone(this.state.income),
      additionalIncome: structuredClone(this.state.additionalIncome),
      monthlyEvents: structuredClone(this.state.monthlyEvents),
      discretionarySpending: structuredClone(this.state.discretionarySpending),
      chartRange: this.state.chartRange
    };
  }

  // ---------- Helpers ----------
  #todayISO() { return new Date().toISOString().split("T")[0]; }

  #parseISO(yyyy_mm_dd) {
    const d = new Date(`${yyyy_mm_dd}T00:00:00`);
    if (Number.isNaN(d.getTime())) throw new Error(`Invalid date: ${yyyy_mm_dd}`);
    return d;
  }

  #toISODate(d) {
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${yyyy}-${mm}-${dd}`;
  }

  #weekdayName(d) {
    const names = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
    return names[d.getDay()];
  }

  #escapeAttr(s) {
    return String(s ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll('"', "&quot;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;");
  }

  #escapeHtml(s) {
    return String(s ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;");
  }

  #deepMerge(target, source) {
    if (!source || typeof source !== "object") return target;
    for (const [k, v] of Object.entries(source)) {
      if (v && typeof v === "object" && !Array.isArray(v)) {
        target[k] = this.#deepMerge(target[k] ?? {}, v);
      } else {
        target[k] = v;
      }
    }
    return target;
  }
}

// Mount
new CashflowTrajectory("#cashflow-app");
</script>
</body>
</html>
