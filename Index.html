<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Financial Wellness Trajectory</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --border:#e9ecef;
      --muted:#6b7280;
      --text:#111827;
      --accent:#16a34a;
      --bg:#ffffff;
      --err:#b00020;
      --r:14px;
    }

    body{
      margin:0;
      padding:28px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    /* -------- Dashboard Layout -------- */
    .dashboard{
      display:grid;
      grid-template-columns: 1fr 460px;
      gap:36px;
      align-items:start;
    }

    /* -------- Left Header -------- */
    .mainTitle{
      font-size:42px;
      font-weight:900;
      letter-spacing:.02em;
      text-transform:uppercase;
      display:inline-block;
      border-bottom:6px solid #111;
      padding-bottom:10px;
      line-height:1.05;
    }

    .bigValue{
      font-size:56px;
      font-weight:900;
      margin-top:18px;
      line-height:1;
    }

    .deltaRow{
      margin-top:8px;
      font-size:18px;
      display:flex;
      gap:8px;
      align-items:center;
    }

    .deltaUp{ color:var(--accent); font-weight:900; }
    .deltaDown{ color:#b00020; font-weight:900; }

    /* -------- Chart + Tabs -------- */
    .chartWrap{
      margin-top:28px;
      padding-bottom:18px;
      border-bottom:1px solid var(--border);
    }

    canvas{ max-width:100%; }

    /* --- Future projection toggle --- */
    .projectionRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-top:14px;
      padding-bottom:14px;
      border-bottom:1px solid var(--border);
    }

    .projectionRow .label{
      font-weight:900;
      letter-spacing:.02em;
      text-transform:uppercase;
      font-size:12px;
      color:#111;
    }

    .switch{
      display:flex;
      align-items:center;
      gap:10px;
      user-select:none;
    }

    .switch input{
      width:46px;
      height:26px;
      appearance:none;
      -webkit-appearance:none;
      border:1px solid var(--border);
      background:#f3f4f6;
      border-radius:999px;
      position:relative;
      cursor:pointer;
      outline:none;
      padding:0;
    }

    .switch input::after{
      content:"";
      width:20px;
      height:20px;
      border-radius:999px;
      background:#fff;
      border:1px solid #d1d5db;
      position:absolute;
      top:50%;
      left:3px;
      transform:translateY(-50%);
      transition: left .15s ease;
    }

    .switch input:checked{
      background: rgba(22,163,74,.18);
      border-color: rgba(22,163,74,.35);
    }

    .switch input:checked::after{
      left:22px;
      border-color: rgba(22,163,74,.45);
    }

    .switch .hintText{
      font-size:12px;
      color: var(--muted);
      white-space:nowrap;
    }

    .rangeTabs{
      display:flex;
      gap:26px;
      margin-top:18px;
      padding-bottom:14px;
      border-bottom:1px solid var(--border);
      align-items:center;
      flex-wrap:wrap;
    }

    .rangeTabs button{
      background:none;
      border:none;
      padding:10px 2px;
      font-weight:900;
      cursor:pointer;
      border-bottom:4px solid transparent;
      letter-spacing:.02em;
      border-radius:0;
      width:auto;
      color:#111;
    }
    .rangeTabs button.active{
      color:var(--accent);
      border-bottom-color:var(--accent);
    }

    /* -------- Preview -------- */
    .hint{ font-size:12px; color:var(--muted); margin-top:8px; }
    .scrollBox{
      max-height:260px;
      overflow:auto;
      background:#f9fafb;
      padding:12px;
      border-radius:10px;
      margin-top:16px;
      border:1px solid var(--border);
    }
    pre{ margin:0; font-size:12px; white-space:pre; }

    /* -------- Monthly Summary Panel -------- */
    .monthSummary{
      margin-top:14px;
      border:1px solid var(--border);
      border-radius:14px;
      padding:14px;
      background:#fff;
    }

    .monthSummary h3{
      margin:0 0 10px;
      font-size:14px;
      font-weight:900;
      letter-spacing:.02em;
      text-transform:uppercase;
    }

    .monthGrid{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
      margin-bottom:12px;
    }

    .kpi{
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px;
      background:#f9fafb;
    }

    .kpi .label{
      font-size:12px;
      color:var(--muted);
      font-weight:700;
    }

    .kpi .value{
      margin-top:6px;
      font-size:18px;
      font-weight:900;
    }

    .breakdowns{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }

    .bdTitle{
      font-size:12px;
      color:var(--muted);
      font-weight:800;
      margin-bottom:6px;
      text-transform:uppercase;
      letter-spacing:.02em;
    }

    .bdList{
      margin:0;
      padding:0;
      list-style:none;
      border:1px solid var(--border);
      border-radius:12px;
      overflow:hidden;
    }

    .bdList li{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:10px;
      border-bottom:1px solid #f2f2f2;
      font-size:13px;
    }

    .bdList li:last-child{ border-bottom:none; }

    .bdAmt{ font-weight:900; white-space:nowrap; }

    /* -------- Sidebar -------- */
    .sidebar{
      border:1px solid var(--border);
      border-radius:10px;
      overflow:hidden;
      background:#fff;
    }

    .sidebarTop{
      display:flex;
      justify-content:space-between;
      padding:18px;
      border-bottom:1px solid var(--border);
      font-weight:900;
      text-transform:uppercase;
      letter-spacing:.02em;
      font-size:18px;
    }

    .accItem{ border-top:1px solid var(--border); }
    .accBtn{
      width:100%;
      background:none;
      border:none;
      padding:18px;
      font-size:22px;
      font-weight:900;
      text-align:left;
      cursor:pointer;
      display:flex;
      justify-content:space-between;
      align-items:center;
      letter-spacing:.01em;
    }
    .accBtn span{ font-size:18px; font-weight:900; }

    .accPanel{ display:none; padding:0 18px 18px; }
    .accItem.open .accPanel{ display:block; }

    /* -------- Forms -------- */
    label{ font-size:12px; color:#444; margin:10px 0 6px; display:block; }
    input, textarea, select, button{
      width:100%;
      padding:10px;
      border-radius:10px;
      border:1px solid #d1d5db;
      box-sizing:border-box;
      font-family: inherit;
    }
    textarea{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    button{
      font-weight:800;
      cursor:pointer;
      background:#fff;
    }
    .btnRow{ display:flex; gap:10px; margin-top:12px; }
    .btnSecondary{ background:#fff; }

    .row{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .radioGroup label{
      margin:6px 0;
      font-size:13px;
      color:#222;
      display:flex;
      gap:8px;
      align-items:center;
    }
    .radioGroup input[type="radio"]{ width:auto; }

    /* Fix radio layout inside sidebar accordions */
    .sidebar .radioGroup{
      display: grid;
      gap: 10px;
      margin-top: 10px;
    }

    .sidebar .radioGroup label{
      display: grid !important;
      grid-template-columns: 22px 1fr;
      align-items: center;
      gap: 12px;
      margin: 0;
      font-size: 15px;
      line-height: 1.25;
      color: #111;
    }

    .sidebar .radioGroup input[type="radio"]{
      width: 18px !important;
      height: 18px !important;
      margin: 0;
      justify-self: start;
    }

    /* -------- Tables -------- */
    table{ width:100%; border-collapse:collapse; margin-top:10px; table-layout:auto; }
    th, td{ padding:8px; border-bottom:1px solid #f2f2f2; text-align:left; vertical-align:top; }
    th{ font-size:12px; color:#555; }

    .tblLabelCell { min-width: 260px; width: auto; }
    .tblDayCell   { width: 90px; }
    .tblAmtCell   { width: 130px; }
    .tblDateCell  { width: 170px; }
    .tblActCell   { width: 110px; }
    .tblLabelInput { width: 100%; }

    .pill{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      background:#f2f2f2;
      font-size:12px;
      color:#555;
      margin-left:8px;
      vertical-align:middle;
      font-weight:700;
    }

    .small{ font-size:12px; color:var(--muted); }
    .error{ color:var(--err); font-size:12px; margin-top:10px; white-space:pre-wrap; }
    hr{ border:none; border-top:1px solid var(--border); margin:14px 0; }

    /* Sidebar table spacing fix */
    .sidebar .accPanel table{
      width: 100%;
      table-layout: fixed;
    }

    .sidebar .accPanel th,
    .sidebar .accPanel td{
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .sidebar .accPanel .tblLabelCell { min-width: 0; width: 46%; }
    .sidebar .accPanel .tblDayCell   { width: 12%; }
    .sidebar .accPanel .tblAmtCell   { width: 16%; }
    .sidebar .accPanel .tblDateCell  { width: 18%; }
    .sidebar .accPanel .tblActCell   { width: 8%; }

    .sidebar .accPanel input,
    .sidebar .accPanel select{
      min-width: 0;
      width: 100%;
    }

    .sidebar .accPanel table input{
      padding: 8px;
      border-radius: 10px;
    }

    .sidebar .accPanel table{
      display: block;
      overflow-x: auto;
    }

    /* Tabs + panels */
    .mobileTabs{ display:none; }
    #panel-chart, #panel-configure, #panel-profiles{ display:block; }

    @media (max-width: 980px){
      .dashboard{ grid-template-columns: 1fr; gap:16px; }

      .mobileTabs{
        display:flex;
        position: sticky;
        top: 0;
        z-index: 50;
        background:#fff;
        border-bottom:1px solid var(--border);
        padding:10px 6px;
        gap:6px;
      }

      .mobileTabs .mTab{
        flex:1;
        border-radius:12px;
        border:1px solid var(--border);
        padding:12px 10px;
        font-weight:900;
        background:#fff;
      }

      .mobileTabs .mTab.active{
        border-color: var(--accent);
        color: var(--accent);
      }

      #panel-chart, #panel-configure, #panel-profiles{ display:none; }
      body[data-mobiletab="chart"] #panel-chart{ display:block; }
      body[data-mobiletab="configure"] #panel-configure{ display:block; }
      body[data-mobiletab="profiles"] #panel-profiles{ display:block; }

      .sidebar{ border-radius:14px; }

      /* summary layout in mobile */
      .monthGrid{ grid-template-columns: 1fr; }
      .breakdowns{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div id="cashflow-app"></div>

<script>
class CashflowTrajectory {
  constructor(mount, options = {}) {
    this.mount = typeof mount === "string" ? document.querySelector(mount) : mount;
    if (!this.mount) throw new Error("Mount element not found.");

    this.onUpdate = typeof options.onUpdate === "function" ? options.onUpdate : null;

    const baseDefaults = {
      startDate: "2026-01-01",
      endDate: "2026-12-31",
      todayDate: this.#todayISO(),
      startingAmount: 0,

      chartRange: "ALL", // 1D,1W,1M,3M,YTD,1Y,ALL
      showFuture: false, // toggle

      income: {
        type: "biweekly",
        biweekly: { label: "Paycheck", firstPayday: "2026-01-02", amount: 1500 },
        weekly:   { label: "Paycheck", weekday: "Friday", amount: 750 },
        irregular: []
      },

      additionalIncome: [],

      monthlyEvents: [
        { label: "Rent",        day: 1,  amount: -1000, startDate: "2026-02-01" },
        { label: "Car payment", day: 15, amount: -700,  startDate: "2026-01-15" }
      ],

      discretionarySpending: []
    };

    this.defaults = this.#deepMerge(structuredClone(baseDefaults), options.defaults ?? {});
    this.state = structuredClone(this.defaults);

    this.chart = null;
    this.rows = [];

    this.#render();
    this.update();
  }

  // ---------- Public API ----------
  setConfig(partial) {
    this.state = this.#deepMerge(this.state, partial);
    this.#syncUIFromState();
    this.#renderIrregularPayTable();
    this.#renderMonthlyEventsTable();
    this.#renderDiscretionaryTable();
    this.#renderAdditionalIncomeTypeField();
    this.#renderAdditionalIncomeTable();
    this.#toggleIncomeUI();
    this.#refreshProfileDropdown();
    this.update();
  }

  getConfig() { return this.#readConfigFromUI(); }

  update() {
    const ui = this.#refs();
    try {
      ui.error.textContent = "";
      const cfg = this.#readConfigFromUI();

      // Expand dataset end if the current view needs more future days than endDate.
      const effectiveEndDate = this.#computeEffectiveDatasetEndDate(cfg);
      const buildCfg = { ...cfg, endDate: effectiveEndDate };

      const rows = this.#buildDataset(buildCfg);
      this.rows = rows;

      const viewRows = this.#sliceRowsForDesiredView(rows, buildCfg);

      this.#renderPreview(viewRows, buildCfg);
      this.#renderMonthSummary(rows, buildCfg);
      this.#renderChart(viewRows, buildCfg);

      if (this.onUpdate) this.onUpdate(rows, buildCfg);
    } catch (err) {
      ui.error.textContent = String(err?.message ?? err);
    }
  }

  // ---------- Render ----------
  #render() {
    this.mount.innerHTML = `
      <nav class="mobileTabs" role="tablist" aria-label="Navigation">
        <button type="button" class="mTab active" data-tab="chart">Chart</button>
        <button type="button" class="mTab" data-tab="configure">Configure</button>
        <button type="button" class="mTab" data-tab="profiles">Profiles</button>
      </nav>

      <div class="dashboard">
        <!-- LEFT -->
        <section id="panel-chart">
          <div class="mainTitle">Financial Wellness Trajectory</div>

          <div class="bigValue" id="cf-balanceBig">$0.00</div>
          <div class="deltaRow">
            <span id="cf-deltaToday" class="deltaUp">▲ $0.00</span>
            <span>Today</span>
          </div>

          <div class="chartWrap">
            <canvas id="cf-chart" height="120"></canvas>
          </div>

          <div class="projectionRow">
            <div class="label">View mode</div>
            <label class="switch" title="OFF = to-date history, ON = projection/forward">
              <input id="cf-showFuture" type="checkbox" />
              <span class="hintText" id="cf-showFutureText">To-date history</span>
            </label>
          </div>

          <div class="rangeTabs" id="cf-rangeTabs">
            <button type="button" data-range="1D">1D</button>
            <button type="button" data-range="1W">1W</button>
            <button type="button" data-range="1M">1M</button>
            <button type="button" data-range="3M">3M</button>
            <button type="button" data-range="YTD">YTD</button>
            <button type="button" data-range="1Y">1Y</button>
            <button type="button" data-range="ALL">ALL</button>
          </div>

          <div class="hint" id="cf-summary" style="margin-top:14px;"></div>

          <div class="monthSummary" id="cf-monthSummary"></div>

          <div class="scrollBox">
            <pre id="cf-preview"></pre>
          </div>
        </section>

        <!-- RIGHT SIDEBAR -->
        <aside class="sidebar">
          <div class="sidebarTop">
            <div>Monthly Configurations</div>
            <div style="font-size:24px; font-weight:900;">+</div>
          </div>

          <!-- CONFIGURE PANEL -->
          <section id="panel-configure">

            <div class="accItem open">
              <button class="accBtn" type="button">PRIMARY INCOME <span>⌄</span></button>
              <div class="accPanel">

                <div class="row">
                  <div>
                    <label>Start date</label>
                    <input id="cf-startDate" type="date" />
                  </div>
                  <div>
                    <label>End date</label>
                    <input id="cf-endDate" type="date" />
                  </div>
                </div>

                <div class="row">
                  <div>
                    <label>Starting balance ($)</label>
                    <input id="cf-startingAmount" type="number" step="100" />
                  </div>
                  <div>
                    <label>Today’s date</label>
                    <input id="cf-todayDate" type="date" />
                    <div class="hint">Defines “today” for to-date vs projection views.</div>
                  </div>
                </div>

                <hr />

                <h4 style="margin:0;">Income <span class="pill" id="cf-incomePill"></span></h4>
                <div class="hint">Choose how you get paid. The chart updates automatically.</div>

                <div class="radioGroup" style="margin-top:10px;">
                  <label><input type="radio" name="cf-incomeType" value="biweekly" /> Bi-weekly paycheck</label>
                  <label><input type="radio" name="cf-incomeType" value="weekly" /> Weekly paycheck</label>
                  <label><input type="radio" name="cf-incomeType" value="irregular" /> Paid per job / irregular income</label>
                </div>

                <div id="cf-income-biweekly" style="margin-top:12px;">
                  <div>
                    <label>Pay label</label>
                    <input id="cf-biweeklyLabel" type="text" placeholder="e.g. Paycheck" />
                  </div>
                  <div class="row">
                    <div>
                      <label>First paycheck date</label>
                      <input id="cf-biweeklyDate" type="date" />
                      <div class="hint">Every 14 days after this date is a payday.</div>
                    </div>
                    <div>
                      <label>Paycheck amount</label>
                      <input id="cf-biweeklyAmount" type="number" step="50" />
                    </div>
                  </div>
                </div>

                <div id="cf-income-weekly" style="display:none; margin-top:12px;">
                  <div>
                    <label>Pay label</label>
                    <input id="cf-weeklyLabel" type="text" placeholder="e.g. Paycheck" />
                  </div>
                  <div class="row">
                    <div>
                      <label>Paid on</label>
                      <select id="cf-weeklyDay">
                        <option>Monday</option><option>Tuesday</option><option>Wednesday</option>
                        <option>Thursday</option><option>Friday</option>
                        <option>Saturday</option><option>Sunday</option>
                      </select>
                    </div>
                    <div>
                      <label>Weekly pay amount</label>
                      <input id="cf-weeklyAmount" type="number" step="50" />
                    </div>
                  </div>
                </div>

                <div id="cf-income-irregular" style="display:none; margin-top:12px;">
                  <div>
                    <label>Description</label>
                    <input id="cf-irregLabel" type="text" placeholder="e.g. Client A – Website, Bonus" />
                  </div>
                  <div class="row">
                    <div>
                      <label>Pay date</label>
                      <input id="cf-irregDate" type="date" />
                    </div>
                    <div>
                      <label>Amount</label>
                      <input id="cf-irregAmount" type="number" step="50" />
                    </div>
                  </div>

                  <div class="btnRow" style="margin-top:10px;">
                    <button id="cf-addPayBtn" type="button">Add paycheck</button>
                    <button id="cf-clearPaysBtn" class="btnSecondary" type="button">Clear list</button>
                  </div>

                  <table>
                    <thead>
                      <tr>
                        <th class="tblLabelCell">Description</th>
                        <th style="width:170px;">Date</th>
                        <th class="tblAmtCell">Amount</th>
                        <th class="tblActCell">Action</th>
                      </tr>
                    </thead>
                    <tbody id="cf-payTable"></tbody>
                  </table>
                  <div class="hint">Tip: Add as many upcoming jobs/checks as you want.</div>
                </div>

              </div>
            </div>

            <div class="accItem">
              <button class="accBtn" type="button">ADDITIONAL INCOME ITEMS <span>⌄</span></button>
              <div class="accPanel">

                <div class="hint">Add extra income sources in addition to your main paycheck.</div>

                <div class="row">
                  <div>
                    <label>Label</label>
                    <input id="cf-aiLabel" type="text" placeholder="e.g. Side gig, Bonus, Reimbursement" />
                  </div>
                  <div>
                    <label>Amount</label>
                    <input id="cf-aiAmount" type="number" step="50" placeholder="e.g. 250" />
                  </div>
                </div>

                <div class="row">
                  <div>
                    <label>Type</label>
                    <select id="cf-aiType">
                      <option value="one_time">One-time (date)</option>
                      <option value="weekly">Weekly (weekday)</option>
                      <option value="monthly">Monthly (day of month)</option>
                    </select>
                  </div>
                  <div id="cf-aiTypeField"></div>
                </div>

                <div class="btnRow">
                  <button id="cf-aiAddBtn" type="button">Add income item</button>
                  <button id="cf-aiClearBtn" class="btnSecondary" type="button">Clear items</button>
                </div>

                <table>
                  <thead>
                    <tr>
                      <th class="tblLabelCell">Label</th>
                      <th class="tblAmtCell">Amount</th>
                      <th style="width:160px;">Type</th>
                      <th style="width:220px;">Rule</th>
                      <th class="tblActCell">Action</th>
                    </tr>
                  </thead>
                  <tbody id="cf-aiTable"></tbody>
                </table>

              </div>
            </div>

            <div class="accItem">
              <button class="accBtn" type="button">FIXED EXPENSES <span>⌄</span></button>
              <div class="accPanel">

                <div class="hint">Add recurring monthly debits/credits (rent, subscriptions, transfers, etc.).</div>

                <div>
                  <label>Event label</label>
                  <input id="cf-newEventLabel" type="text" placeholder="e.g. Rent, Car payment" />
                </div>

                <div class="row">
                  <div>
                    <label>Day of month</label>
                    <input id="cf-newEventDay" type="number" min="1" max="31" value="15" />
                  </div>
                  <div>
                    <label>Amount (+ deposit / - debit)</label>
                    <input id="cf-newEventAmount" type="number" step="50" value="-700" />
                  </div>
                </div>

                <div class="row">
                  <div>
                    <label>Start date</label>
                    <input id="cf-newEventStart" type="date" />
                  </div>
                  <div style="display:flex; align-items:end;">
                    <button id="cf-addEventBtn" type="button">Add event</button>
                  </div>
                </div>

                <table>
                  <thead>
                    <tr>
                      <th class="tblLabelCell">Label</th>
                      <th class="tblDayCell">Day</th>
                      <th class="tblAmtCell">Amount</th>
                      <th class="tblDateCell">Start date</th>
                      <th class="tblActCell">Action</th>
                    </tr>
                  </thead>
                  <tbody id="cf-eventsTbody"></tbody>
                </table>

              </div>
            </div>

            <div class="accItem">
              <button class="accBtn" type="button">DISCRETIONARY SPENDING <span>⌄</span></button>
              <div class="accPanel">

                <div class="hint">Add recurring monthly “budget spending” items (groceries, gas, eating out, etc.).</div>

                <div>
                  <label>Category label</label>
                  <input id="cf-newSpendLabel" type="text" placeholder="e.g. Groceries, Gas, Restaurants" />
                </div>

                <div class="row">
                  <div>
                    <label>Day of month</label>
                    <input id="cf-newSpendDay" type="number" min="1" max="31" value="1" />
                  </div>
                  <div>
                    <label>Amount (use negative for spending)</label>
                    <input id="cf-newSpendAmount" type="number" step="50" value="-300" />
                  </div>
                </div>

                <div class="row">
                  <div>
                    <label>Start date</label>
                    <input id="cf-newSpendStart" type="date" />
                  </div>
                  <div style="display:flex; align-items:end;">
                    <button id="cf-addSpendBtn" type="button">Add category</button>
                  </div>
                </div>

                <table>
                  <thead>
                    <tr>
                      <th class="tblLabelCell">Label</th>
                      <th class="tblDayCell">Day</th>
                      <th class="tblAmtCell">Amount</th>
                      <th class="tblDateCell">Start date</th>
                      <th class="tblActCell">Action</th>
                    </tr>
                  </thead>
                  <tbody id="cf-spendTbody"></tbody>
                </table>

              </div>
            </div>

          </section>

          <!-- PROFILES PANEL -->
          <section id="panel-profiles">
            <div class="accItem">
              <button class="accBtn" type="button">SAVED PROFILES <span>⌄</span></button>
              <div class="accPanel">

                <div class="row">
                  <div>
                    <label for="cf-profileName">Profile name</label>
                    <input id="cf-profileName" type="text" placeholder="e.g. Baseline, Paycheck v2" />
                  </div>
                  <div>
                    <label for="cf-profileSelect">Saved profiles</label>
                    <select id="cf-profileSelect">
                      <option value="">(none saved)</option>
                    </select>
                  </div>
                </div>

                <div class="btnRow">
                  <button id="cf-saveProfileBtn" type="button">Save profile</button>
                  <button id="cf-loadProfileBtn" type="button" class="btnSecondary">Load</button>
                  <button id="cf-deleteProfileBtn" type="button" class="btnSecondary">Delete</button>
                </div>

                <div class="btnRow">
                  <button id="cf-runBtn" type="button">Generate Chart</button>
                  <button id="cf-resetBtn" type="button" class="btnSecondary">Reset</button>
                </div>

                <div id="cf-error" class="error"></div>
              </div>
            </div>
          </section>

        </aside>
      </div>
    `;

    // Post-render routines
    this.#syncUIFromState();
    this.#renderIrregularPayTable();
    this.#renderMonthlyEventsTable();
    this.#renderDiscretionaryTable();
    this.#renderAdditionalIncomeTypeField();
    this.#renderAdditionalIncomeTable();
    this.#wireEvents();
    this.#toggleIncomeUI();
    this.#refreshProfileDropdown();
  }

  // ---------- Events ----------
  #wireEvents() {
    // Mobile top tabs
    const tabButtons = Array.from(this.mount.querySelectorAll(".mobileTabs .mTab"));
    const setMobileTab = (name) => {
      document.body.dataset.mobiletab = name;
      tabButtons.forEach(b => b.classList.toggle("active", b.dataset.tab === name));
    };
    if (!document.body.dataset.mobiletab) setMobileTab("chart");
    tabButtons.forEach(btn => btn.addEventListener("click", () => setMobileTab(btn.dataset.tab)));

    const ui = this.#refs();

    // Accordion open/close
    this.mount.querySelectorAll(".accBtn").forEach(btn => {
      btn.addEventListener("click", () => {
        const item = btn.closest(".accItem");
        if (!item) return;
        item.classList.toggle("open");
      });
    });

    // Range tabs
    this.mount.querySelectorAll("#cf-rangeTabs button").forEach(b => {
      b.addEventListener("click", () => {
        this.state.chartRange = b.dataset.range;
        this.mount.querySelectorAll("#cf-rangeTabs button").forEach(x => x.classList.remove("active"));
        b.classList.add("active");
        this.update();
      });
    });

    // Toggle
    ui.showFuture?.addEventListener("change", () => {
      this.state.showFuture = !!ui.showFuture.checked;
      this.#syncToggleText();
      this.update();
    });

    [ui.startDate, ui.endDate, ui.todayDate, ui.startingAmount].forEach(el =>
      el.addEventListener("change", () => this.update())
    );

    ui.incomeRadios.forEach(r => {
      r.addEventListener("change", () => {
        this.state.income.type = r.value;
        this.#toggleIncomeUI();
        this.update();
      });
    });

    [ui.biweeklyLabel, ui.biweeklyDate, ui.biweeklyAmount].forEach(el =>
      el.addEventListener("change", () => this.update())
    );

    [ui.weeklyLabel, ui.weeklyDay, ui.weeklyAmount].forEach(el =>
      el.addEventListener("change", () => this.update())
    );

    ui.addPayBtn.addEventListener("click", () => {
      try { ui.error.textContent = ""; this.#addIrregularPayFromInputs(); this.update(); }
      catch (err) { ui.error.textContent = String(err?.message ?? err); }
    });

    ui.clearPaysBtn.addEventListener("click", () => {
      this.state.income.irregular = [];
      this.#renderIrregularPayTable();
      this.update();
    });

    ui.payTableBody.addEventListener("click", (e) => {
      const btn = e.target;
      if (btn?.dataset?.action !== "removePay") return;
      const idx = Number(btn.dataset.idx);
      if (!Number.isFinite(idx)) return;
      this.state.income.irregular.splice(idx, 1);
      this.#renderIrregularPayTable();
      this.update();
    });

    // Additional Income UI
    ui.aiType.addEventListener("change", () => this.#renderAdditionalIncomeTypeField());

    ui.aiAddBtn.addEventListener("click", () => {
      try { ui.error.textContent = ""; this.#addAdditionalIncomeFromInputs(); this.update(); }
      catch (err) { ui.error.textContent = String(err?.message ?? err); }
    });

    ui.aiClearBtn.addEventListener("click", () => {
      this.state.additionalIncome = [];
      this.#renderAdditionalIncomeTable();
      this.update();
    });

    ui.aiTable.addEventListener("click", (e) => {
      const btn = e.target;
      if (btn?.dataset?.action !== "aiRemove") return;
      const idx = Number(btn.dataset.idx);
      if (!Number.isFinite(idx)) return;
      this.state.additionalIncome.splice(idx, 1);
      this.#renderAdditionalIncomeTable();
      this.update();
    });

    // Fixed expenses
    ui.addEventBtn.addEventListener("click", () => {
      try { ui.error.textContent = ""; this.#addMonthlyEventFromInputs(); this.#renderMonthlyEventsTable(); this.update(); }
      catch (err) { ui.error.textContent = String(err?.message ?? err); }
    });

    ui.eventsTbody.addEventListener("change", (e) => {
      const el = e.target;
      const idx = Number(el?.dataset?.idx);
      const field = el?.dataset?.field;
      if (!Number.isFinite(idx) || !field) return;

      const ev = this.state.monthlyEvents[idx];
      if (!ev) return;

      if (field === "label") ev.label = el.value;
      if (field === "day") ev.day = Number(el.value);
      if (field === "amount") ev.amount = Number(el.value);
      if (field === "startDate") ev.startDate = el.value;

      this.update();
    });

    ui.eventsTbody.addEventListener("click", (e) => {
      const btn = e.target;
      if (btn?.dataset?.action !== "removeEvent") return;
      const idx = Number(btn.dataset.idx);
      if (!Number.isFinite(idx)) return;
      this.state.monthlyEvents.splice(idx, 1);
      this.#renderMonthlyEventsTable();
      this.update();
    });

    // Discretionary spending
    ui.addSpendBtn?.addEventListener("click", () => {
      try {
        ui.error.textContent = "";
        this.#addDiscretionaryFromInputs();
        this.#renderDiscretionaryTable();
        this.update();
      } catch (err) {
        ui.error.textContent = String(err?.message ?? err);
      }
    });

    ui.spendTbody?.addEventListener("change", (e) => {
      const el = e.target;
      const idx = Number(el?.dataset?.idx);
      const field = el?.dataset?.field;
      if (!Number.isFinite(idx) || !field) return;

      const it = this.state.discretionarySpending[idx];
      if (!it) return;

      if (field === "label") it.label = el.value;
      if (field === "day") it.day = Number(el.value);
      if (field === "amount") it.amount = Number(el.value);
      if (field === "startDate") it.startDate = el.value;

      this.update();
    });

    ui.spendTbody?.addEventListener("click", (e) => {
      const btn = e.target;
      if (btn?.dataset?.action !== "removeSpend") return;
      const idx = Number(btn.dataset.idx);
      if (!Number.isFinite(idx)) return;

      this.state.discretionarySpending.splice(idx, 1);
      this.#renderDiscretionaryTable();
      this.update();
    });

    // Profiles
    ui.profileSelect?.addEventListener("change", () => {
      if (ui.profileName) ui.profileName.value = ui.profileSelect.value || "";
    });

    ui.saveProfileBtn?.addEventListener("click", () => {
      try {
        ui.error.textContent = "";
        this.#saveProfile(ui.profileName?.value);
        const n = (ui.profileName?.value ?? "").trim();
        if (n) ui.profileSelect.value = n;
      } catch (err) {
        ui.error.textContent = String(err?.message ?? err);
      }
    });

    ui.loadProfileBtn?.addEventListener("click", () => {
      try { ui.error.textContent = ""; this.#loadProfile(ui.profileSelect?.value); }
      catch (err) { ui.error.textContent = String(err?.message ?? err); }
    });

    ui.deleteProfileBtn?.addEventListener("click", () => {
      try {
        ui.error.textContent = "";
        this.#deleteProfile(ui.profileSelect?.value);
        if (ui.profileName) ui.profileName.value = "";
      } catch (err) {
        ui.error.textContent = String(err?.message ?? err);
      }
    });

    ui.runBtn.addEventListener("click", () => this.update());
    ui.resetBtn.addEventListener("click", () => {
      this.state = structuredClone(this.defaults);
      this.#syncUIFromState();
      this.#renderIrregularPayTable();
      this.#renderMonthlyEventsTable();
      this.#renderDiscretionaryTable();
      this.#renderAdditionalIncomeTypeField();
      this.#renderAdditionalIncomeTable();
      this.#toggleIncomeUI();
      this.#refreshProfileDropdown();
      this.update();
    });
  }

  #toggleIncomeUI() {
    const ui = this.#refs();
    const type = this.state.income.type;

    ui.incomePill.textContent = type === "biweekly" ? "Bi-weekly" : (type === "weekly" ? "Weekly" : "Irregular");
    ui.sectionBiweekly.style.display = type === "biweekly" ? "" : "none";
    ui.sectionWeekly.style.display   = type === "weekly"   ? "" : "none";
    ui.sectionIrregular.style.display= type === "irregular" ? "" : "none";
    ui.incomeRadios.forEach(r => r.checked = (r.value === type));
  }

  // ---------- Saved Profiles ----------
  #profileKey(name) { return `cf_profile_v1:${name}`; }

  #listProfiles() {
    return Object.keys(localStorage)
      .filter(k => k.startsWith("cf_profile_v1:"))
      .map(k => k.replace("cf_profile_v1:", ""))
      .sort((a, b) => a.localeCompare(b));
  }

  #refreshProfileDropdown() {
    const ui = this.#refs();
    if (!ui.profileSelect) return;

    const names = this.#listProfiles();
    ui.profileSelect.innerHTML = names.length
      ? names.map(n => `<option value="${this.#escapeAttr(n)}">${this.#escapeHtml(n)}</option>`).join("")
      : `<option value="">(none saved)</option>`;
  }

  #saveProfile(name) {
    const n = String(name ?? "").trim();
    if (!n) throw new Error("Profile name is required.");
    const cfg = this.getConfig();
    localStorage.setItem(this.#profileKey(n), JSON.stringify(cfg));
    this.#refreshProfileDropdown();
  }

  #loadProfile(name) {
    const n = String(name ?? "").trim();
    if (!n) throw new Error("Choose a profile to load.");
    const raw = localStorage.getItem(this.#profileKey(n));
    if (!raw) throw new Error("Profile not found.");
    const cfg = JSON.parse(raw);
    this.setConfig(cfg);
  }

  #deleteProfile(name) {
    const n = String(name ?? "").trim();
    if (!n) throw new Error("Choose a profile to delete.");
    localStorage.removeItem(this.#profileKey(n));
    this.#refreshProfileDropdown();
  }

  // ---------- Irregular Income ----------
  #addIrregularPayFromInputs() {
    const ui = this.#refs();
    const label = ui.irregLabel.value.trim() || "Income";
    const date = ui.irregDate.value;
    const amount = Number(ui.irregAmount.value);

    if (!date) throw new Error("Pay date is required.");
    if (!Number.isFinite(amount)) throw new Error("Pay amount must be a number.");

    this.state.income.irregular.push({ label, date, amount });
    this.state.income.irregular.sort((a, b) => a.date.localeCompare(b.date));

    ui.irregLabel.value = "";
    ui.irregAmount.value = "";
    this.#renderIrregularPayTable();
  }

  #renderIrregularPayTable() {
    const ui = this.#refs();
    const pays = this.state.income.irregular ?? [];

    if (!pays.length) {
      ui.payTableBody.innerHTML = `<tr><td colspan="4" class="small">No paychecks added yet.</td></tr>`;
      return;
    }

    ui.payTableBody.innerHTML = pays.map((p, idx) => `
      <tr>
        <td class="tblLabelCell">${this.#escapeHtml(p.label)}</td>
        <td>${this.#escapeHtml(p.date)}</td>
        <td>$${Number(p.amount).toLocaleString()}</td>
        <td><button type="button" data-action="removePay" data-idx="${idx}">Remove</button></td>
      </tr>
    `).join("");
  }

  // ---------- Additional Income ----------
  #renderAdditionalIncomeTypeField() {
    const ui = this.#refs();
    const type = ui.aiType.value;

    if (type === "one_time") {
      ui.aiTypeField.innerHTML = `
        <label>Date</label>
        <input id="cf-aiDate" type="date" />
      `;
    } else if (type === "weekly") {
      ui.aiTypeField.innerHTML = `
        <label>Weekday + start date</label>
        <div class="row">
          <select id="cf-aiWeekday">
            <option>Monday</option><option>Tuesday</option><option>Wednesday</option>
            <option>Thursday</option><option>Friday</option><option>Saturday</option><option>Sunday</option>
          </select>
          <input id="cf-aiStart" type="date" />
        </div>
      `;
    } else {
      ui.aiTypeField.innerHTML = `
        <label>Day of month + start date</label>
        <div class="row">
          <input id="cf-aiDay" type="number" min="1" max="31" value="1" />
          <input id="cf-aiStart" type="date" />
        </div>
      `;
    }

    const dateEl = this.mount.querySelector("#cf-aiDate");
    const startEl = this.mount.querySelector("#cf-aiStart");
    if (dateEl && !dateEl.value) dateEl.value = ui.startDate.value;
    if (startEl && !startEl.value) startEl.value = ui.startDate.value;
  }

  #addAdditionalIncomeFromInputs() {
    const ui = this.#refs();
    const label = ui.aiLabel.value.trim() || "Additional income";
    const amount = Number(ui.aiAmount.value);
    const type = ui.aiType.value;

    if (!Number.isFinite(amount)) throw new Error("Additional income amount must be a number.");

    if (type === "one_time") {
      const date = this.mount.querySelector("#cf-aiDate")?.value;
      if (!date) throw new Error("One-time income requires a date.");
      this.state.additionalIncome.push({ label, type, amount, date });
    } else if (type === "weekly") {
      const weekday = this.mount.querySelector("#cf-aiWeekday")?.value;
      const startDate = this.mount.querySelector("#cf-aiStart")?.value;
      if (!weekday || !startDate) throw new Error("Weekly income requires weekday and start date.");
      this.state.additionalIncome.push({ label, type, amount, weekday, startDate });
    } else {
      const day = Number(this.mount.querySelector("#cf-aiDay")?.value);
      const startDate = this.mount.querySelector("#cf-aiStart")?.value;
      if (!Number.isFinite(day) || day < 1 || day > 31) throw new Error("Monthly income day must be 1–31.");
      if (!startDate) throw new Error("Monthly income requires a start date.");
      this.state.additionalIncome.push({ label, type, amount, day, startDate });
    }

    ui.aiLabel.value = "";
    ui.aiAmount.value = "";
    this.#renderAdditionalIncomeTable();
  }

  #renderAdditionalIncomeTable() {
    const ui = this.#refs();
    const items = this.state.additionalIncome ?? [];

    if (!items.length) {
      ui.aiTable.innerHTML = `<tr><td colspan="5" class="small">No additional income items.</td></tr>`;
      return;
    }

    ui.aiTable.innerHTML = items.map((it, idx) => {
      const rule =
        it.type === "one_time" ? it.date :
        it.type === "weekly" ? `${it.weekday} (from ${it.startDate})` :
        `Day ${it.day} (from ${it.startDate})`;

      return `
        <tr>
          <td class="tblLabelCell">${this.#escapeHtml(it.label)}</td>
          <td class="tblAmtCell">$${Number(it.amount).toLocaleString()}</td>
          <td>${this.#escapeHtml(it.type)}</td>
          <td>${this.#escapeHtml(rule)}</td>
          <td class="tblActCell">
            <button type="button" data-action="aiRemove" data-idx="${idx}">Remove</button>
          </td>
        </tr>
      `;
    }).join("");
  }

  // ---------- Monthly Events ----------
  #addMonthlyEventFromInputs() {
    const ui = this.#refs();
    const label = ui.newEventLabel.value.trim() || "Monthly event";
    const day = Number(ui.newEventDay.value);
    const amount = Number(ui.newEventAmount.value);
    const startDate = ui.newEventStart.value;

    if (!Number.isFinite(day) || day < 1 || day > 31) throw new Error("Monthly event day must be 1–31.");
    if (!Number.isFinite(amount)) throw new Error("Monthly event amount must be a number.");
    if (!startDate) throw new Error("Monthly event start date is required.");

    this.state.monthlyEvents.push({ label, day, amount, startDate });
    ui.newEventLabel.value = "";
  }

  #renderMonthlyEventsTable() {
    const ui = this.#refs();
    const events = this.state.monthlyEvents ?? [];

    if (!events.length) {
      ui.eventsTbody.innerHTML = `<tr><td colspan="5" class="small">No monthly events yet. Add one above.</td></tr>`;
      return;
    }

    ui.eventsTbody.innerHTML = events.map((ev, idx) => `
      <tr>
        <td class="tblLabelCell">
          <input class="tblLabelInput" data-idx="${idx}" data-field="label" type="text"
                 value="${this.#escapeAttr(ev.label)}" />
        </td>
        <td class="tblDayCell">
          <input data-idx="${idx}" data-field="day" type="number" min="1" max="31"
                 value="${Number(ev.day)}" />
        </td>
        <td class="tblAmtCell">
          <input data-idx="${idx}" data-field="amount" type="number" step="50"
                 value="${Number(ev.amount)}" />
        </td>
        <td class="tblDateCell">
          <input data-idx="${idx}" data-field="startDate" type="date"
                 value="${this.#escapeAttr(ev.startDate)}" />
        </td>
        <td class="tblActCell">
          <button type="button" data-action="removeEvent" data-idx="${idx}">Remove</button>
        </td>
      </tr>
    `).join("");
  }

  // ---------- Discretionary Spending ----------
  #addDiscretionaryFromInputs() {
    const ui = this.#refs();
    const label = ui.newSpendLabel.value.trim() || "Discretionary spending";
    const day = Number(ui.newSpendDay.value);
    const amount = Number(ui.newSpendAmount.value);
    const startDate = ui.newSpendStart.value;

    if (!Number.isFinite(day) || day < 1 || day > 31) throw new Error("Spending day must be 1–31.");
    if (!Number.isFinite(amount)) throw new Error("Spending amount must be a number.");
    if (!startDate) throw new Error("Spending start date is required.");

    this.state.discretionarySpending.push({ label, day, amount, startDate });
    ui.newSpendLabel.value = "";
  }

  #renderDiscretionaryTable() {
    const ui = this.#refs();
    const items = this.state.discretionarySpending ?? [];
    if (!ui.spendTbody) return;

    if (!items.length) {
      ui.spendTbody.innerHTML = `<tr><td colspan="5" class="small">No discretionary categories yet. Add one above.</td></tr>`;
      return;
    }

    ui.spendTbody.innerHTML = items.map((it, idx) => `
      <tr>
        <td class="tblLabelCell">
          <input class="tblLabelInput" data-idx="${idx}" data-field="label" type="text"
                 value="${this.#escapeAttr(it.label)}" />
        </td>
        <td class="tblDayCell">
          <input data-idx="${idx}" data-field="day" type="number" min="1" max="31"
                 value="${Number(it.day)}" />
        </td>
        <td class="tblAmtCell">
          <input data-idx="${idx}" data-field="amount" type="number" step="50"
                 value="${Number(it.amount)}" />
        </td>
        <td class="tblDateCell">
          <input data-idx="${idx}" data-field="startDate" type="date"
                 value="${this.#escapeAttr(it.startDate)}" />
        </td>
        <td class="tblActCell">
          <button type="button" data-action="removeSpend" data-idx="${idx}">Remove</button>
        </td>
      </tr>
    `).join("");
  }

  // ---------- Dataset Engine ----------
  #buildDataset(cfg) {
    const start = this.#parseISO(cfg.startDate);
    const end = this.#parseISO(cfg.endDate);
    if (end < start) throw new Error("End date must be on/after start date.");
    const today = this.#parseISO(cfg.todayDate);

    let balance = Number(cfg.startingAmount);
    if (!Number.isFinite(balance)) throw new Error("Starting amount must be a number.");

    const monthlyEvents = (cfg.monthlyEvents ?? []).map((ev, i) => {
      const label = String(ev.label ?? "Monthly event");
      const day = Number(ev.day);
      const amount = Number(ev.amount);
      const startDate = this.#parseISO(ev.startDate);

      if (!Number.isFinite(day) || day < 1 || day > 31) throw new Error(`Monthly event #${i + 1}: day must be 1–31.`);
      if (!Number.isFinite(amount)) throw new Error(`Monthly event #${i + 1}: amount must be a number.`);
      return { label, day, amount, startDate };
    });

    const discretionary = (cfg.discretionarySpending ?? []).map((ev, i) => {
      const label = String(ev.label ?? "Discretionary spending");
      const day = Number(ev.day);
      const amount = Number(ev.amount);
      const startDate = this.#parseISO(ev.startDate);

      if (!Number.isFinite(day) || day < 1 || day > 31) throw new Error(`Discretionary item #${i + 1}: day must be 1–31.`);
      if (!Number.isFinite(amount)) throw new Error(`Discretionary item #${i + 1}: amount must be a number.`);
      return { label, day, amount, startDate };
    });

    const irregularMap = this.#irregularPaysToMap(cfg.income.irregular);

    const rows = [];
    for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
      const cur = new Date(d);
      const curISO = this.#toISODate(cur);
      let net = 0;
      const reasons = [];
      const txns = []; // structured transactions for summaries

      // Primary paycheck
      if (cfg.income.type === "biweekly") {
        const label = (cfg.income.biweekly.label || "Paycheck").trim() || "Paycheck";
        const fp = this.#parseISO(cfg.income.biweekly.firstPayday);
        const amt = Number(cfg.income.biweekly.amount);
        if (!Number.isFinite(amt)) throw new Error("Bi-weekly paycheck amount must be a number.");

        if (cur >= fp) {
          const diffDays = Math.floor((cur - fp) / 86400000);
          if (diffDays % 14 === 0) {
            net += amt;
            reasons.push(`${label}: +${amt}`);
            txns.push({ label, amount: amt });
          }
        }
      } else if (cfg.income.type === "weekly") {
        const label = (cfg.income.weekly.label || "Paycheck").trim() || "Paycheck";
        const amt = Number(cfg.income.weekly.amount);
        if (!Number.isFinite(amt)) throw new Error("Weekly pay amount must be a number.");

        if (this.#weekdayName(cur) === cfg.income.weekly.weekday) {
          net += amt;
          reasons.push(`${label}: +${amt}`);
          txns.push({ label, amount: amt });
        }
      } else if (cfg.income.type === "irregular") {
        const obj = irregularMap.get(curISO);
        if (obj) {
          net += obj.total;
          obj.labels.forEach(s => reasons.push(s));
          obj.txns.forEach(t => txns.push(t));
        }
      }

      // Additional income
      for (const it of (cfg.additionalIncome ?? [])) {
        const amt = Number(it.amount);
        if (!Number.isFinite(amt)) continue;

        if (it.type === "one_time" && curISO === it.date) {
          net += amt;
          reasons.push(`${it.label}: +${amt}`);
          txns.push({ label: it.label, amount: amt });
        }

        if (it.type === "weekly") {
          if (cur >= this.#parseISO(it.startDate) && this.#weekdayName(cur) === it.weekday) {
            net += amt;
            reasons.push(`${it.label}: +${amt}`);
            txns.push({ label: it.label, amount: amt });
          }
        }

        if (it.type === "monthly") {
          if (cur >= this.#parseISO(it.startDate) && cur.getDate() === Number(it.day)) {
            net += amt;
            reasons.push(`${it.label}: +${amt}`);
            txns.push({ label: it.label, amount: amt });
          }
        }
      }

      // Fixed monthly events
      for (const ev of monthlyEvents) {
        if (cur >= ev.startDate && cur.getDate() === ev.day) {
          net += ev.amount;
          reasons.push(`${ev.label}: ${ev.amount >= 0 ? "+" : ""}${ev.amount}`);
          txns.push({ label: ev.label, amount: ev.amount });
        }
      }

      // Discretionary spending
      for (const ev of discretionary) {
        if (cur >= ev.startDate && cur.getDate() === ev.day) {
          net += ev.amount;
          reasons.push(`${ev.label}: ${ev.amount >= 0 ? "+" : ""}${ev.amount}`);
          txns.push({ label: ev.label, amount: ev.amount });
        }
      }

      balance += net;

      rows.push({
        date: curISO,
        net_change: net,
        eod_balance: balance,
        reasons,
        txns,
        is_today: curISO === this.#toISODate(today)
      });
    }

    return rows;
  }

  #irregularPaysToMap(pays) {
    const map = new Map();
    (pays ?? []).forEach((p, i) => {
      if (!p.date) throw new Error(`Irregular paycheck #${i + 1}: date required.`);
      const date = this.#parseISO(p.date);
      const amt = Number(p.amount);
      if (!Number.isFinite(amt)) throw new Error(`Irregular paycheck #${i + 1}: amount must be a number.`);

      const iso = this.#toISODate(date);
      const label = String(p.label ?? "Income").trim() || "Income";
      const labelLine = `${label}: ${amt >= 0 ? "+" : ""}${amt}`;

      const cur = map.get(iso) ?? { total: 0, labels: [], txns: [] };
      cur.total += amt;
      cur.labels.push(labelLine);
      cur.txns.push({ label, amount: amt });
      map.set(iso, cur);
    });
    return map;
  }

  // ---------- View Rules (YOUR SPEC) ----------
  #computeEffectiveDatasetEndDate(cfg) {
    const range = String(cfg.chartRange ?? "ALL").toUpperCase();
    const showFuture = !!cfg.showFuture;

    const endUI = this.#parseISO(cfg.endDate);
    const today = this.#parseISO(cfg.todayDate);

    const addDays = (d, n) => {
      const x = new Date(d);
      x.setDate(x.getDate() + n);
      return x;
    };

    // default = keep UI endDate, but never earlier than today
    let neededEnd = endUI < today ? today : endUI;

    if (!showFuture) return this.#toISODate(neededEnd);

    // showFuture ON: some ranges require extra future beyond endDate
    if (range === "1W") neededEnd = this.#maxDate(neededEnd, addDays(today, 7));
    if (range === "1M") neededEnd = this.#maxDate(neededEnd, addDays(today, 30));
    if (range === "3M") neededEnd = this.#maxDate(neededEnd, addDays(today, 90));
    if (range === "1Y") neededEnd = this.#maxDate(neededEnd, addDays(today, 365));

    if (range === "YTD") {
      const dec31 = new Date(today.getFullYear(), 11, 31);
      neededEnd = this.#maxDate(neededEnd, dec31);
    }

    // ALL uses cfg.endDate (but we already ensured >= today above)
    return this.#toISODate(neededEnd);
  }

  #sliceRowsForDesiredView(rows, cfg) {
    const range = String(cfg.chartRange ?? "ALL").toUpperCase();
    const showFuture = !!cfg.showFuture;

    const todayISO = this.#toISODate(this.#parseISO(cfg.todayDate));
    const todayIdxRaw = rows.findIndex(r => r.date === todayISO);
    const todayIdx = todayIdxRaw >= 0 ? todayIdxRaw : (rows.length - 1);

    const rowDate = (idx) => this.#parseISO(rows[idx].date);

    const clampIdx = (idx) => Math.max(0, Math.min(rows.length - 1, idx));

    const idxForDate = (dateObj) => {
      const iso = this.#toISODate(dateObj);
      const i = rows.findIndex(r => r.date === iso);
      return i >= 0 ? i : null;
    };

    const startOfWeekMonday = (d) => {
      const x = new Date(d);
      const day = x.getDay(); // 0 Sun..6 Sat
      const diff = (day === 0) ? 6 : (day - 1); // Monday start
      x.setDate(x.getDate() - diff);
      x.setHours(0,0,0,0);
      return x;
    };

    const startOfMonth = (d) => new Date(d.getFullYear(), d.getMonth(), 1);
    const startOfYear = (d) => new Date(d.getFullYear(), 0, 1);
    const endOfYear = (d) => new Date(d.getFullYear(), 11, 31);

    const todayDate = rowDate(todayIdx);

    const sliceByIdx = (startIdx, endIdx) => {
      const a = clampIdx(startIdx);
      const b = clampIdx(endIdx);
      return rows.slice(Math.min(a,b), Math.max(a,b) + 1);
    };

    // ===== TOGGLE OFF: "to-date history" =====
    if (!showFuture) {
      if (range === "ALL") return sliceByIdx(0, todayIdx);
      if (range === "1D") return sliceByIdx(todayIdx, todayIdx);

      if (range === "1W") {
        const s = startOfWeekMonday(todayDate);
        const sIdx = idxForDate(s) ?? 0;
        return sliceByIdx(sIdx, todayIdx);
      }

      if (range === "1M") {
        const s = startOfMonth(todayDate);
        const sIdx = idxForDate(s) ?? 0;
        return sliceByIdx(sIdx, todayIdx);
      }

      if (range === "YTD") {
        const s = startOfYear(todayDate);
        const sIdx = idxForDate(s) ?? 0;
        return sliceByIdx(sIdx, todayIdx);
      }

      if (range === "3M") return sliceByIdx(todayIdx - 89, todayIdx); // 90 days incl today
      if (range === "1Y") return sliceByIdx(todayIdx - 364, todayIdx); // 365 days incl today

      return sliceByIdx(0, todayIdx);
    }

    // ===== TOGGLE ON: "projection/forward" =====
    // Special rule you asked for:
    // 1D + toggle ON => YTD history (not projection)
    if (range === "1D") {
      const s = startOfYear(todayDate);
      const sIdx = idxForDate(s) ?? 0;
      return sliceByIdx(sIdx, todayIdx);
    }

    if (range === "ALL") {
      // all history & projected trajectory
      return rows;
    }

    if (range === "YTD") {
      // remainder of year trajectory: today -> Dec 31
      const end = endOfYear(todayDate);
      const endIdx = idxForDate(end) ?? (rows.length - 1);
      return sliceByIdx(todayIdx, endIdx);
    }

    if (range === "1W") return sliceByIdx(todayIdx, todayIdx + 7);
    if (range === "1M") return sliceByIdx(todayIdx, todayIdx + 30);
    if (range === "3M") return sliceByIdx(todayIdx, todayIdx + 90);
    if (range === "1Y") return sliceByIdx(todayIdx, todayIdx + 365);

    return rows;
  }

  // ---------- Preview + Chart ----------
  #renderPreview(viewRows, cfg) {
    const ui = this.#refs();

    // Big value/delta always stays "today"
    this.#renderTodayHeader(this.rows, cfg);

    ui.preview.textContent = viewRows.map(r => {
      const reasons = (r.reasons?.length ? " | " + r.reasons.join("; ") : "");
      return `${r.date} | net ${r.net_change >= 0 ? "+" : ""}${r.net_change} | balance $${r.eod_balance.toLocaleString()}${reasons}`;
    }).join("\n");

    const first = viewRows[0];
    const last = viewRows[viewRows.length - 1];

    const mode = cfg.showFuture ? "Projection / forward" : "To-date history";
    ui.summary.textContent =
      `${mode} • Range: ${String(cfg.chartRange).toUpperCase()} • Window: ${first.date} → ${last.date} • Points: ${viewRows.length.toLocaleString()}`;
  }

  #renderTodayHeader(allRows, cfg) {
    const todayISO = this.#toISODate(this.#parseISO(cfg.todayDate));
    const todayRow = allRows.find(r => r.date === todayISO) ?? allRows[allRows.length - 1];
    const todayIdx = allRows.findIndex(r => r.date === todayRow.date);

    const big = this.mount.querySelector("#cf-balanceBig");
    if (big) big.textContent = `$${Number(todayRow.eod_balance).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

    const deltaEl = this.mount.querySelector("#cf-deltaToday");
    if (deltaEl) {
      const prev = todayIdx > 0 ? allRows[todayIdx - 1].eod_balance : todayRow.eod_balance;
      const diff = Number(todayRow.eod_balance) - Number(prev);

      const sign = diff >= 0 ? "▲" : "▼";
      const txt = `${sign} $${Math.abs(diff).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
      deltaEl.textContent = txt;

      deltaEl.classList.toggle("deltaUp", diff >= 0);
      deltaEl.classList.toggle("deltaDown", diff < 0);
    }
  }

  #renderChart(viewRows, cfg) {
    const ui = this.#refs();
    const labels = viewRows.map(r => r.date);

    const todayISO = this.#toISODate(this.#parseISO(cfg.todayDate));
    const todayIdx = viewRows.findIndex(r => r.date === todayISO);

    // If the window doesn't contain today, treat everything as actual (solid).
    const cutoff = todayIdx >= 0 ? todayIdx : (viewRows.length - 1);

    const actual = viewRows.map((r, i) => (i <= cutoff ? r.eod_balance : null));
    const proj   = viewRows.map((r, i) => (i >= cutoff ? r.eod_balance : null)); // include today point for smooth connect

    const singlePoint = viewRows.length <= 1;

    if (this.chart) this.chart.destroy();

    this.chart = new Chart(ui.canvas, {
      type: "line",
      data: {
        labels,
        datasets: [
          {
            label: "Actual (to-date)",
            data: actual,
            borderWidth: 3,
            pointRadius: singlePoint ? 4 : 0,
            tension: 0.12,
            borderColor: "#16a34a",
            spanGaps: true
          },
          {
            label: "Projection",
            data: proj,
            borderWidth: 3,
            pointRadius: 0,
            tension: 0.12,
            borderColor: "#16a34a",
            borderDash: [6, 6],
            spanGaps: true
          }
        ]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: (ctx) => `$${Number(ctx.parsed.y).toLocaleString()}`,
              afterBody: (items) => {
                const i = items?.[0]?.dataIndex;
                const r = viewRows?.[i];
                if (!r?.reasons?.length) return "";
                return r.reasons.join("\n");
              }
            }
          }
        },
        interaction: { mode: "index", intersect: false },
        scales: {
          x: { ticks: { maxTicksLimit: 12 } },
          y: { ticks: { callback: (v) => `$${Number(v).toLocaleString()}` } }
        }
      }
    });
  }

  // ---------- Monthly Summary (CALENDAR MONTH FORECAST) ----------
  #renderMonthSummary(allRows, cfg){
    const ui = this.#refs();
    if (!ui.monthSummary) return;

    const todayISO = this.#toISODate(this.#parseISO(cfg.todayDate));
    const today = this.#parseISO(todayISO);

    // Calendar month boundaries based on todayDate
    const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
    const monthEnd   = new Date(today.getFullYear(), today.getMonth() + 1, 0);

    const monthStartISO = this.#toISODate(monthStart);
    const monthEndISO   = this.#toISODate(monthEnd);

    // Rows in this calendar month
    const monthRows = allRows.filter(r => r.date >= monthStartISO && r.date <= monthEndISO);

    // Posted vs Scheduled split (always)
    const postedRows    = monthRows.filter(r => r.date <= todayISO);
    const scheduledRows = monthRows.filter(r => r.date > todayISO);

    const sumTotals = (rows, wantPositive) => {
      let s = 0;
      rows.forEach(r => {
        (r.txns ?? []).forEach(t => {
          const amt = Number(t.amount);
          if (!Number.isFinite(amt)) return;
          if (wantPositive && amt > 0) s += amt;
          if (!wantPositive && amt < 0) s += amt;
        });
      });
      return s;
    };

    const sumByLabel = (rows, wantPositive) => {
      const m = new Map();
      rows.forEach(r => {
        (r.txns ?? []).forEach(t => {
          const amt = Number(t.amount);
          if (!Number.isFinite(amt)) return;

          if (wantPositive && amt <= 0) return;
          if (!wantPositive && amt >= 0) return;

          const key = String(t.label ?? "Other");
          m.set(key, (m.get(key) ?? 0) + amt);
        });
      });
      return m;
    };

    const topN = (map, n, wantAbs=false) => {
      const arr = Array.from(map.entries());
      arr.sort((a,b) => wantAbs ? (Math.abs(b[1]) - Math.abs(a[1])) : (b[1] - a[1]));
      return arr.slice(0, n);
    };

    const fmt = (n) =>
      `$${Math.abs(Number(n)).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

    // Full calendar month forecast (1st -> last)
    const incMonth = sumTotals(monthRows, true);
    const expMonth = sumTotals(monthRows, false); // negative
    const netMonth = incMonth + expMonth;

    // Posted vs Scheduled
    const incPosted = sumTotals(postedRows, true);
    const expPosted = sumTotals(postedRows, false);
    const netPosted = incPosted + expPosted;

    const incSched = sumTotals(scheduledRows, true);
    const expSched = sumTotals(scheduledRows, false);
    const netSched = incSched + expSched;

    // Breakdowns for FULL month forecast
    const incMap = sumByLabel(monthRows, true);
    const expMap = sumByLabel(monthRows, false);

    const incTop = topN(incMap, 6);
    const expTop = topN(expMap, 6, true);

    ui.monthSummary.innerHTML = `
      <h3>Monthly forecast (${monthStartISO} → ${monthEndISO})</h3>

      <div class="monthGrid">
        <div class="kpi">
          <div class="label">Total income (month)</div>
          <div class="value">${fmt(incMonth)}</div>
        </div>
        <div class="kpi">
          <div class="label">Total spending (month)</div>
          <div class="value">${fmt(expMonth)}</div>
        </div>
        <div class="kpi">
          <div class="label">Projected net (month)</div>
          <div class="value">${netMonth >= 0 ? fmt(netMonth) : "-" + fmt(netMonth)}</div>
        </div>
      </div>

      <div class="monthGrid" style="margin-top:10px;">
        <div class="kpi">
          <div class="label">Posted so far</div>
          <div class="value">${netPosted >= 0 ? fmt(netPosted) : "-" + fmt(netPosted)}</div>
        </div>
        <div class="kpi">
          <div class="label">Scheduled remaining</div>
          <div class="value">${netSched >= 0 ? fmt(netSched) : "-" + fmt(netSched)}</div>
        </div>
        <div class="kpi">
          <div class="label">Today</div>
          <div class="value">${this.#escapeHtml(todayISO)}</div>
        </div>
      </div>

      <div class="breakdowns" style="margin-top:12px;">
        <div>
          <div class="bdTitle">Where it’s coming from (month)</div>
          <ul class="bdList">
            ${incTop.length ? incTop.map(([k,v]) => `
              <li><span>${this.#escapeHtml(k)}</span><span class="bdAmt">${fmt(v)}</span></li>
            `).join("") : `<li><span>No income scheduled this month.</span><span class="bdAmt">$0.00</span></li>`}
          </ul>
        </div>

        <div>
          <div class="bdTitle">Where it’s going (month)</div>
          <ul class="bdList">
            ${expTop.length ? expTop.map(([k,v]) => `
              <li><span>${this.#escapeHtml(k)}</span><span class="bdAmt">-${fmt(v)}</span></li>
            `).join("") : `<li><span>No spending scheduled this month.</span><span class="bdAmt">$0.00</span></li>`}
          </ul>
        </div>
      </div>
    `;
  }

  // ---------- Refs + Sync ----------
  #refs() {
    return {
      startDate: this.mount.querySelector("#cf-startDate"),
      endDate: this.mount.querySelector("#cf-endDate"),
      todayDate: this.mount.querySelector("#cf-todayDate"),
      startingAmount: this.mount.querySelector("#cf-startingAmount"),

      incomePill: this.mount.querySelector("#cf-incomePill"),
      incomeRadios: Array.from(this.mount.querySelectorAll('input[name="cf-incomeType"]')),

      sectionBiweekly: this.mount.querySelector("#cf-income-biweekly"),
      sectionWeekly: this.mount.querySelector("#cf-income-weekly"),
      sectionIrregular: this.mount.querySelector("#cf-income-irregular"),

      biweeklyLabel: this.mount.querySelector("#cf-biweeklyLabel"),
      biweeklyDate: this.mount.querySelector("#cf-biweeklyDate"),
      biweeklyAmount: this.mount.querySelector("#cf-biweeklyAmount"),

      weeklyLabel: this.mount.querySelector("#cf-weeklyLabel"),
      weeklyDay: this.mount.querySelector("#cf-weeklyDay"),
      weeklyAmount: this.mount.querySelector("#cf-weeklyAmount"),

      irregLabel: this.mount.querySelector("#cf-irregLabel"),
      irregDate: this.mount.querySelector("#cf-irregDate"),
      irregAmount: this.mount.querySelector("#cf-irregAmount"),
      addPayBtn: this.mount.querySelector("#cf-addPayBtn"),
      clearPaysBtn: this.mount.querySelector("#cf-clearPaysBtn"),
      payTableBody: this.mount.querySelector("#cf-payTable"),

      aiLabel: this.mount.querySelector("#cf-aiLabel"),
      aiAmount: this.mount.querySelector("#cf-aiAmount"),
      aiType: this.mount.querySelector("#cf-aiType"),
      aiTypeField: this.mount.querySelector("#cf-aiTypeField"),
      aiAddBtn: this.mount.querySelector("#cf-aiAddBtn"),
      aiClearBtn: this.mount.querySelector("#cf-aiClearBtn"),
      aiTable: this.mount.querySelector("#cf-aiTable"),

      newEventLabel: this.mount.querySelector("#cf-newEventLabel"),
      newEventDay: this.mount.querySelector("#cf-newEventDay"),
      newEventAmount: this.mount.querySelector("#cf-newEventAmount"),
      newEventStart: this.mount.querySelector("#cf-newEventStart"),
      addEventBtn: this.mount.querySelector("#cf-addEventBtn"),
      eventsTbody: this.mount.querySelector("#cf-eventsTbody"),

      newSpendLabel: this.mount.querySelector("#cf-newSpendLabel"),
      newSpendDay: this.mount.querySelector("#cf-newSpendDay"),
      newSpendAmount: this.mount.querySelector("#cf-newSpendAmount"),
      newSpendStart: this.mount.querySelector("#cf-newSpendStart"),
      addSpendBtn: this.mount.querySelector("#cf-addSpendBtn"),
      spendTbody: this.mount.querySelector("#cf-spendTbody"),

      profileName: this.mount.querySelector("#cf-profileName"),
      profileSelect: this.mount.querySelector("#cf-profileSelect"),
      saveProfileBtn: this.mount.querySelector("#cf-saveProfileBtn"),
      loadProfileBtn: this.mount.querySelector("#cf-loadProfileBtn"),
      deleteProfileBtn: this.mount.querySelector("#cf-deleteProfileBtn"),

      runBtn: this.mount.querySelector("#cf-runBtn"),
      resetBtn: this.mount.querySelector("#cf-resetBtn"),
      error: this.mount.querySelector("#cf-error"),

      preview: this.mount.querySelector("#cf-preview"),
      summary: this.mount.querySelector("#cf-summary"),
      canvas: this.mount.querySelector("#cf-chart"),

      showFuture: this.mount.querySelector("#cf-showFuture"),
      showFutureText: this.mount.querySelector("#cf-showFutureText"),

      monthSummary: this.mount.querySelector("#cf-monthSummary"),
    };
  }

  #syncToggleText() {
    const ui = this.#refs();
    if (!ui.showFutureText) return;
    ui.showFutureText.textContent = this.state.showFuture ? "Projection / forward" : "To-date history";
  }

  #syncUIFromState() {
    const ui = this.#refs();

    ui.startDate.value = this.state.startDate;
    ui.endDate.value = this.state.endDate;
    ui.todayDate.value = this.state.todayDate;
    ui.startingAmount.value = String(this.state.startingAmount);

    ui.incomeRadios.forEach(r => r.checked = (r.value === this.state.income.type));

    ui.biweeklyLabel.value = this.state.income.biweekly.label;
    ui.biweeklyDate.value = this.state.income.biweekly.firstPayday;
    ui.biweeklyAmount.value = String(this.state.income.biweekly.amount);

    ui.weeklyLabel.value = this.state.income.weekly.label;
    ui.weeklyDay.value = this.state.income.weekly.weekday;
    ui.weeklyAmount.value = String(this.state.income.weekly.amount);

    ui.irregDate.value = this.state.startDate;

    // Range active state
    const r = String(this.state.chartRange ?? "ALL").toUpperCase();
    this.mount.querySelectorAll("#cf-rangeTabs button").forEach(x => {
      x.classList.toggle("active", x.dataset.range === r);
    });

    // Toggle state
    if (ui.showFuture) ui.showFuture.checked = !!this.state.showFuture;
    this.#syncToggleText();
  }

  #readConfigFromUI() {
    const ui = this.#refs();

    const selectedType = ui.incomeRadios.find(r => r.checked)?.value ?? this.state.income.type;
    this.state.income.type = selectedType;

    this.state.startDate = ui.startDate.value;
    this.state.endDate = ui.endDate.value;
    this.state.todayDate = ui.todayDate.value;
    this.state.startingAmount = Number(ui.startingAmount.value || 0);

    this.state.income.biweekly.label = ui.biweeklyLabel.value.trim() || "Paycheck";
    this.state.income.biweekly.firstPayday = ui.biweeklyDate.value;
    this.state.income.biweekly.amount = Number(ui.biweeklyAmount.value || 0);

    this.state.income.weekly.label = ui.weeklyLabel.value.trim() || "Paycheck";
    this.state.income.weekly.weekday = ui.weeklyDay.value;
    this.state.income.weekly.amount = Number(ui.weeklyAmount.value || 0);

    this.state.showFuture = !!ui.showFuture?.checked;
    this.#syncToggleText();

    return {
      startDate: this.state.startDate,
      endDate: this.state.endDate,
      todayDate: this.state.todayDate,
      startingAmount: this.state.startingAmount,
      income: structuredClone(this.state.income),
      additionalIncome: structuredClone(this.state.additionalIncome),
      monthlyEvents: structuredClone(this.state.monthlyEvents),
      discretionarySpending: structuredClone(this.state.discretionarySpending),
      chartRange: this.state.chartRange,
      showFuture: this.state.showFuture,
    };
  }

  // ---------- Helpers ----------
  #todayISO() { return new Date().toISOString().split("T")[0]; }

  #parseISO(yyyy_mm_dd) {
    const d = new Date(`${yyyy_mm_dd}T00:00:00`);
    if (Number.isNaN(d.getTime())) throw new Error(`Invalid date: ${yyyy_mm_dd}`);
    return d;
  }

  #toISODate(d) {
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${yyyy}-${mm}-${dd}`;
  }

  #weekdayName(d) {
    const names = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
    return names[d.getDay()];
  }

  #escapeAttr(s) {
    return String(s ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll('"', "&quot;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;");
  }

  #escapeHtml(s) {
    return String(s ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;");
  }

  #deepMerge(target, source) {
    if (!source || typeof source !== "object") return target;
    for (const [k, v] of Object.entries(source)) {
      if (v && typeof v === "object" && !Array.isArray(v)) {
        target[k] = this.#deepMerge(target[k] ?? {}, v);
      } else {
        target[k] = v;
      }
    }
    return target;
  }

  #maxDate(a, b) { return (a.getTime() >= b.getTime()) ? a : b; }
}

// Mount
new CashflowTrajectory("#cashflow-app");
</script>
</body>
</html>
